<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emoji Box Simulator v0.5.2</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f1b3a, #1e3a5f, #2d5a8c);
            color: white;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
        }

        .version {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .author {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            margin: 50px auto;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form input {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
        }

        .auth-form button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-form button:hover {
            transform: translateY(-2px);
        }

        .auth-switch {
            margin-top: 15px;
            font-size: 14px;
            color: #a0c8ff;
            cursor: pointer;
            text-decoration: underline;
        }

        h1 {
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            font-size: 2.2rem;
        }

        .user-info {
            position: absolute;
            top: 10px;
            right: 80px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            font-size: 24px;
            cursor: pointer;
        }

        .settings-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
            cursor: pointer;
            font-size: 20px;
            transition: all 0.3s ease;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4a90e2;
            text-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
        }

        .box-section {
            position: relative;
            margin: 30px auto;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(10px);
        }

        .box-container {
            perspective: 1200px;
            margin: 0 auto;
            width: 220px;
            height: 220px;
            position: relative;
        }

        .box {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .box.open {
            transform: rotateX(-115deg) translateY(-30px);
        }

        .box-face {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            backface-visibility: visible;
            border: 3px solid rgba(255, 255, 255, 0.6);
            border-radius: 12px;
            box-shadow: inset 0 0 25px rgba(255, 255, 255, 0.3);
        }

        .box-top {
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            transform: rotateX(90deg) translateZ(110px);
        }

        .box-front {
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            transform: translateZ(110px);
        }

        .box-back {
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            transform: rotateY(180deg) translateZ(110px);
        }

        .box-left {
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            transform: rotateY(-90deg) translateZ(110px);
        }

        .box-right {
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            transform: rotateY(90deg) translateZ(110px);
        }

        .box-bottom {
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            transform: rotateX(-90deg) translateZ(110px);
        }

        .box-lid {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: top;
            transform-style: preserve-3d;
            transition: transform 1s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .box.open .box-lid {
            transform: rotateX(-115deg);
        }

        .lid-top {
            background: linear-gradient(145deg, #5fa8ff, #4a90e2);
            transform: rotateX(90deg) translateZ(110px);
            box-shadow: 0 0 40px rgba(95, 168, 255, 0.8);
        }

        .lid-front, .lid-back, .lid-left, .lid-right {
            background: linear-gradient(145deg, #5fa8ff, #4a90e2);
            transform: translateZ(110px);
            height: 25px;
            top: 0;
        }

        .lid-back { transform: rotateY(180deg) translateZ(110px); }
        .lid-left { transform: rotateY(-90deg) translateZ(110px); }
        .lid-right { transform: rotateY(90deg) translateZ(110px); }

        .box-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 320px;
            height: 320px;
            border-radius: 50%;
            background: radial-gradient(circle, 
                rgba(95, 168, 255, 0.9) 0%, 
                rgba(74, 144, 226, 0.7) 20%, 
                rgba(45, 90, 140, 0.5) 40%, 
                rgba(31, 58, 92, 0.3) 60%, 
                transparent 80%);
            opacity: 0;
            z-index: -1;
            filter: blur(35px);
            transition: opacity 0.4s ease;
        }

        .box.open ~ .box-glow {
            opacity: 1;
            animation: intense-glow 1.2s infinite alternate;
        }

        @keyframes intense-glow {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 0.8; }
            100% { transform: translate(-50%, -50%) scale(1.4); opacity: 1; }
        }

        .box-sparkles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .sparkle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: sparkle 1.5s ease-out forwards;
        }

        @keyframes sparkle {
            0% { transform: scale(0) rotate(0deg); opacity: 0; }
            50% { transform: scale(1) rotate(180deg); opacity: 1; }
            100% { transform: scale(0) rotate(360deg); opacity: 0; }
        }

        .open-btn {
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            margin: 25px 0;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            font-weight: bold;
            letter-spacing: 1px;
            position: relative;
            overflow: hidden;
        }

        .open-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: 0.5s;
        }

        .open-btn:hover::before {
            left: 100%;
        }

        .open-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }

        .open-btn:active {
            transform: translateY(0);
        }

        .open-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .result {
            margin: 25px 0;
            min-height: 100px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 60px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            padding: 15px;
            animation: pulse 1.5s infinite;
            border: 2px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 -3px 0 #4a90e2;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .inventory {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }

        .category {
            margin-bottom: 25px;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 10px;
        }

        .category h3 {
            margin-bottom: 15px;
            text-align: left;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 8px;
            font-size: 1.4rem;
            display: flex;
            justify-content: space-between;
        }

        .progress {
            font-size: 0.9rem;
            color: #4a90e2;
        }

        .emoji-list {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: flex-start;
        }

        .emoji-item {
            font-size: 28px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.3s ease;
            min-width: 60px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .emoji-item.owned {
            background: rgba(74, 144, 226, 0.4);
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(74, 144, 226, 0.5);
        }

        .emoji-item.selected {
            background: rgba(255, 215, 0, 0.6);
            box-shadow: 0 0 20px gold;
            transform: scale(1.2);
        }

        .emoji-item.new {
            animation: highlight 2s ease;
        }

        @keyframes highlight {
            0% { background: rgba(255, 255, 0, 0.7); transform: scale(1.3); box-shadow: 0 0 20px yellow; }
            70% { background: rgba(74, 144, 226, 0.6); transform: scale(1.15); box-shadow: 0 0 15px #4a90e2; }
            100% { background: rgba(74, 144, 226, 0.4); transform: scale(1.1); box-shadow: 0 0 10px rgba(74, 144, 226, 0.5); }
        }

        .emoji-item.missing {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.5);
            cursor: default;
        }

        /* Анимированный медведь */
        .animated-bear {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff, #e0f7fa, #b2ebf2);
            box-shadow: 
                0 0 20px rgba(255, 255, 255, 0.8),
                0 0 40px rgba(173, 216, 230, 0.6),
                inset 0 0 20px rgba(255, 255, 255, 0.5);
            animation: bear-shine 3s infinite alternate;
            transform-style: preserve-3d;
            perspective: 500px;
        }

        .animated-bear::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            width: 10px;
            height: 10px;
            background: #2c3e50;
            border-radius: 50%;
            box-shadow: 25px 0 #2c3e50;
            animation: bear-blink 4s infinite;
        }

        .animated-bear::after {
            content: '';
            position: absolute;
            bottom: 15px;
            left: 20px;
            width: 20px;
            height: 10px;
            background: #2c3e50;
            border-radius: 50%;
        }

        @keyframes bear-shine {
            0%, 100% { 
                transform: scale(1.1) rotateY(0deg);
                box-shadow: 
                    0 0 20px rgba(255, 255, 255, 0.8),
                    0 0 40px rgba(173, 216, 230, 0.6),
                    inset 0 0 20px rgba(255, 255, 255, 0.5);
            }
            25% { 
                transform: scale(1.15) rotateY(10deg);
                box-shadow: 
                    0 0 25px rgba(255, 255, 255, 0.9),
                    0 0 50px rgba(173, 216, 230, 0.8),
                    inset 0 0 25px rgba(255, 255, 255, 0.6);
            }
            50% { 
                transform: scale(1.2) rotateY(0deg);
                box-shadow: 
                    0 0 30px rgba(255, 255, 255, 1),
                    0 0 60px rgba(173, 216, 230, 1),
                    inset 0 0 30px rgba(255, 255, 255, 0.7);
            }
            75% { 
                transform: scale(1.15) rotateY(-10deg);
                box-shadow: 
                    0 0 25px rgba(255, 255, 255, 0.9),
                    0 0 50px rgba(173, 216, 230, 0.8),
                    inset 0 0 25px rgba(255, 255, 255, 0.6);
            }
        }

        @keyframes bear-blink {
            0%, 45%, 55%, 100% {
                transform: scaleY(1);
            }
            50% {
                transform: scaleY(0.1);
            }
        }

        .animated-bear .bear-ear {
            position: absolute;
            top: -5px;
            width: 15px;
            height: 15px;
            background: #ffffff;
            border-radius: 50%;
            box-shadow: 
                inset -2px -2px 5px rgba(0,0,0,0.1),
                0 0 10px rgba(255,255,255,0.5);
        }

        .animated-bear .bear-ear.left {
            left: 10px;
        }

        .animated-bear .bear-ear.right {
            right: 10px;
        }

        /* Анимированная тыква */
        .animated-pumpkin {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 60px;
            border-radius: 50% 50% 40% 40%;
            background: linear-gradient(135deg, #ff7518, #ff8c00, #ff4500);
            box-shadow: 
                0 0 20px rgba(255, 117, 24, 0.8),
                0 0 40px rgba(255, 140, 0, 0.6),
                inset 0 0 20px rgba(255, 69, 0, 0.5);
            animation: pumpkin-glow 3s infinite alternate;
            transform-style: preserve-3d;
            perspective: 500px;
        }

        .animated-pumpkin::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 15px;
            width: 8px;
            height: 8px;
            background: #2c3e50;
            border-radius: 50%;
            box-shadow: 20px 0 #2c3e50;
            animation: pumpkin-blink 3s infinite;
        }

        .animated-pumpkin::after {
            content: '⌄';
            position: absolute;
            bottom: 10px;
            left: 20px;
            width: 20px;
            height: 10px;
            color: #2c3e50;
            font-size: 16px;
            text-align: center;
            animation: pumpkin-smile 4s infinite;
        }

        @keyframes pumpkin-glow {
            0%, 100% { 
                transform: scale(1.1);
                box-shadow: 
                    0 0 20px rgba(255, 117, 24, 0.8),
                    0 0 40px rgba(255, 140, 0, 0.6),
                    inset 0 0 20px rgba(255, 69, 0, 0.5);
            }
            50% { 
                transform: scale(1.15);
                box-shadow: 
                    0 0 30px rgba(255, 117, 24, 1),
                    0 0 60px rgba(255, 140, 0, 0.8),
                    inset 0 0 30px rgba(255, 69, 0, 0.7);
            }
        }

        @keyframes pumpkin-blink {
            0%, 40%, 60%, 100% {
                transform: scaleY(1);
            }
            50% {
                transform: scaleY(0.1);
            }
        }

        @keyframes pumpkin-smile {
            0%, 70%, 100% {
                content: '⌄';
            }
            75%, 95% {
                content: '⏜';
            }
        }

        .animated-pumpkin .pumpkin-stem {
            position: absolute;
            top: -8px;
            left: 25px;
            width: 10px;
            height: 12px;
            background: #228B22;
            border-radius: 50% 50% 0 0;
            transform: rotate(10deg);
        }

        /* Games Styles */
        .games-container {
            padding: 20px;
        }

        .game-selection {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .game-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .game-card:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #4a90e2;
            transform: translateY(-5px);
        }

        .game-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .game-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            color: #4a90e2;
        }

        .game-reward {
            font-size: 1.1rem;
            color: #FFD700;
            margin-bottom: 15px;
        }

        .game-description {
            font-size: 0.9rem;
            color: #ccc;
            margin-bottom: 15px;
        }

        /* Find Emoji Game Styles */
        .find-emoji-game {
            text-align: center;
            padding: 20px;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .level-info {
            font-size: 18px;
            font-weight: bold;
            color: #4a90e2;
        }

        .timer {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
        }

        .target-emoji {
            font-size: 40px;
            margin: 20px 0;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .emoji-cell {
            font-size: 24px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-cell:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .emoji-cell.correct {
            background: rgba(76, 175, 80, 0.6);
            transform: scale(1.2);
        }

        .emoji-cell.wrong {
            background: rgba(244, 67, 54, 0.6);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .game-result {
            font-size: 24px;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Smile Clicker Game Styles */
        .clicker-game {
            text-align: center;
            padding: 20px;
        }

        .clicker-timer {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 20px;
        }

        .clicker-score {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .clicker-area {
            width: 300px;
            height: 300px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            border: 3px solid #4a90e2;
        }

        .clicker-emoji {
            position: absolute;
            font-size: 40px;
            cursor: pointer;
            transition: transform 0.1s;
            user-select: none;
        }

        .clicker-emoji:active {
            transform: scale(0.9);
        }

        /* Memory Game Styles */
        .memory-game {
            text-align: center;
            padding: 20px;
        }

        .memory-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .memory-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin: 20px 0;
            max-height: 500px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .memory-cell {
            font-size: 20px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .memory-cell:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .memory-cell.matched {
            background: rgba(76, 175, 80, 0.6);
            cursor: default;
        }

        .memory-cell.selected {
            background: rgba(255, 193, 7, 0.6);
            transform: scale(1.1);
        }

        .memory-complete {
            font-size: 24px;
            color: #4a90e2;
            margin: 20px 0;
            padding: 15px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* Shooting Range Game Styles */
        .shooting-game {
            text-align: center;
            padding: 20px;
        }

        .shooting-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .shooting-range {
            width: 600px;
            height: 400px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            border: 3px solid #4a90e2;
            cursor: crosshair;
        }

        .target {
            position: absolute;
            font-size: 40px;
            user-select: none;
            animation: target-float 3s infinite alternate;
        }

        @keyframes target-float {
            0% { transform: translateY(0px); }
            100% { transform: translateY(20px); }
        }

        .bullet {
            position: absolute;
            font-size: 20px;
            user-select: none;
            pointer-events: none;
        }

        /* Boss Battle Game Styles */
        .boss-game {
            text-align: center;
            padding: 20px;
        }

        .boss-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .boss-arena {
            width: 600px;
            height: 400px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            margin: 0 auto 20px;
            position: relative;
            overflow: hidden;
            border: 3px solid #4a90e2;
        }

        .player {
            position: absolute;
            font-size: 40px;
            user-select: none;
            transition: all 0.1s ease;
            z-index: 10;
        }

        .boss {
            position: absolute;
            font-size: 80px;
            user-select: none;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            animation: boss-float 2s infinite alternate;
        }

        @keyframes boss-float {
            0% { transform: translateX(-50%) translateY(0px); }
            100% { transform: translateX(-50%) translateY(10px); }
        }

        .projectile {
            position: absolute;
            font-size: 20px;
            user-select: none;
            pointer-events: none;
            transition: transform 0.1s ease;
        }

        .laser {
            position: absolute;
            background: linear-gradient(90deg, transparent, #ff0000, transparent);
            height: 3px;
            animation: laser-glow 0.5s infinite alternate;
        }

        @keyframes laser-glow {
            0% { box-shadow: 0 0 5px #ff0000; }
            100% { box-shadow: 0 0 15px #ff0000, 0 0 30px #ff0000; }
        }

        .rock {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #8B4513;
            border-radius: 50%;
            user-select: none;
            pointer-events: none;
        }

        /* Emoji Creator Styles */
        .creator-container {
            padding: 20px;
        }

        .creator-cost {
            font-size: 18px;
            color: #FFD700;
            margin-bottom: 20px;
        }

        .creator-preview {
            width: 120px;
            height: 120px;
            margin: 0 auto 30px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border: 3px solid rgba(255, 255, 255, 0.3);
        }

        .custom-emoji {
            position: relative;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #ffcc00;
        }

        .emoji-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }

        .emoji-eyes {
            position: absolute;
            top: 25px;
            width: 100%;
            display: flex;
            justify-content: space-around;
        }

        .eye {
            width: 12px;
            height: 12px;
            background: #000;
            border-radius: 50%;
        }

        .emoji-mouth {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 10px;
            background: #000;
            border-radius: 0 0 10px 10px;
        }

        .creator-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .option-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
        }

        .option-group h3 {
            margin-bottom: 15px;
            color: #4a90e2;
        }

        .option-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .option-btn {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 5px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .option-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .option-btn.active {
            background: #4a90e2;
            box-shadow: 0 0 10px rgba(74, 144, 226, 0.5);
        }

        .color-picker {
            width: 100%;
            height: 40px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.9);
        }

        .create-btn {
            background: linear-gradient(145deg, #ff6b35, #ff8e53);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            margin: 20px 0;
            box-shadow: 0 8px 20px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .create-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(255, 107, 53, 0.4);
        }

        .create-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        /* Quests Styles */
        .quests-container {
            padding: 20px;
        }

        .quests-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .quest-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #4a90e2;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quest-card:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .quest-card.special {
            border-left: 4px solid #FFD700;
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
        }

        .quest-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #4a90e2;
        }

        .quest-card.special .quest-title {
            color: #FFD700;
        }

        .quest-description {
            font-size: 0.9rem;
            margin-bottom: 10px;
            color: #ccc;
        }

        .quest-progress {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin: 0 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a90e2, #5fa8ff);
            transition: width 0.3s ease;
        }

        .quest-reward {
            font-size: 0.9rem;
            color: #FFD700;
            font-weight: bold;
        }

        .quest-completed {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid #4CAF50;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .settings-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e3a5f, #2d5a8c);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .settings-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 8px;
        }

        .volume-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 15px 0;
        }

        .volume-slider {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            background: #4a90e2;
            border-radius: 50%;
            cursor: pointer;
        }

        .account-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .account-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .account-item:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .account-item.current {
            background: rgba(74, 144, 226, 0.3);
            border: 1px solid #4a90e2;
        }

        .account-actions {
            display: flex;
            gap: 10px;
        }

        .account-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .account-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .account-btn.login {
            background: rgba(76, 175, 80, 0.6);
        }

        .account-btn.login:hover {
            background: rgba(76, 175, 80, 0.8);
        }

        .account-btn.logout {
            background: rgba(244, 67, 54, 0.6);
        }

        .account-btn.logout:hover {
            background: rgba(244, 67, 54, 0.8);
        }

        .close-settings {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        .profile-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .profile-form input {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 16px;
            color: #333;
        }

        .profile-form button {
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(145deg, #4a90e2, #2d5a8c);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .profile-form button:hover {
            transform: translateY(-2px);
        }

        .avatar-selection {
            margin-top: 20px;
        }

        .avatar-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .rates-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .rates-table th, .rates-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rates-table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: bold;
        }

        .rates-table tr:last-child td {
            border-bottom: none;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 18px;
            border-radius: 10px;
            transform: translateX(150%);
            transition: transform 0.5s ease;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-left: 5px solid #4a90e2;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .coins-animation {
            position: fixed;
            font-size: 28px;
            z-index: 100;
            animation: coins-float 2s ease-out forwards;
            pointer-events: none;
        }

        @keyframes coins-float {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-120px) scale(0.5); opacity: 0; }
        }

        .disappear-effect {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 100px;
            z-index: 200;
            animation: disappear 3s forwards;
            pointer-events: none;
        }

        @keyframes disappear {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            20% { transform: translate(-50%, -50%) scale(1.5); opacity: 0.8; }
            40% { transform: translate(-50%, -50%) scale(0.8) rotate(180deg); opacity: 0.6; }
            60% { transform: translate(-50%, -50%) scale(1.2) rotate(360deg); opacity: 0.4; }
            80% { transform: translate(-50%, -50%) scale(0.5) rotate(540deg); opacity: 0.2; }
            100% { transform: translate(-50%, -50%) scale(0.1) rotate(720deg); opacity: 0; }
        }

        /* Joystick for mobile */
        .joystick-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 120px;
            height: 120px;
            display: none;
            z-index: 100;
        }

        .joystick {
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            position: relative;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .joystick-handle {
            position: absolute;
            width: 50px;
            height: 50px;
            background: rgba(74, 144, 226, 0.8);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.1s;
        }

        /* Quest Preview Modal */
        .quest-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .quest-preview-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1e3a5f, #2d5a8c);
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .quest-preview-emoji {
            font-size: 100px;
            margin: 20px 0;
        }

        .close-quest-preview {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }

        /* Добавляем недостающие CSS-анимации */
        @keyframes rainbow-shift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes shine {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px #ffff00; }
            100% { box-shadow: 0 0 20px #ffff00, 0 0 30px #ffff00; }
        }
        
        /* Добавляем background-size для анимации shine */
        .custom-emoji[style*="shine"] {
            background-size: 200px 100%;
        }

        /* Control Panel for Boss Game */
        .control-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 100;
        }

        .control-row {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
            cursor: pointer;
            user-select: none;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }

        .control-btn:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.9);
        }

        @media (max-width: 600px) {
            .stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .box-container {
                width: 180px;
                height: 180px;
            }
            
            .box-face, .lid-top {
                transform: rotateX(90deg) translateZ(90px);
            }
            
            .box-front, .box-back, .box-left, .box-right, .lid-front, .lid-back, .lid-left, .lid-right {
                transform: translateZ(90px);
            }
            
            .emoji-grid, .memory-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .emoji-list {
                justify-content: center;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .open-btn {
                padding: 12px 30px;
                font-size: 18px;
            }

            .settings-btn {
                right: 10px;
            }

            .user-info {
                right: 70px;
            }

            .game-selection {
                grid-template-columns: 1fr;
            }

            .quests-grid {
                grid-template-columns: 1fr;
            }

            .shooting-range, .boss-arena {
                width: 100%;
                height: 300px;
            }

            .creator-options {
                grid-template-columns: 1fr;
            }

            /* Показываем джойстик на мобильных устройствах */
            .joystick-container {
                display: block;
            }

            /* Скрываем панель управления на мобильных */
            .control-panel {
                display: none;
            }
        }

        @media (min-width: 601px) {
            /* Скрываем джойстик на десктопе */
            .joystick-container {
                display: none;
            }

            /* Показываем панель управления на десктопе */
            .control-panel {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="version">v0.5.2</div>
    <div class="author">Автор: ZELMIR</div>
    
    <!-- Аудио элементы для музыки -->
    <audio id="background-music" loop>
        <source src="music/menu-theme-halloween.mp3" type="audio/mpeg">
        Ваш браузер не поддерживает аудио элемент.
    </audio>
    <audio id="boss-music">
        <source src="music/protiv-bossa.mp3" type="audio/mpeg">
        Ваш браузер не поддерживает аудио элемент.
    </audio>
    
    <div id="auth-container" class="auth-container">
        <h2>Вход в игру</h2>
        <div class="auth-form" id="login-form">
            <input type="text" id="username" placeholder="Имя пользователя" required>
            <input type="password" id="password" placeholder="Пароль" required>
            <button id="auth-btn">Войти</button>
            <div class="auth-switch" id="switch-to-register">Нет аккаунта? Зарегистрироваться</div>
        </div>
        <div class="auth-form" id="register-form" style="display: none;">
            <input type="text" id="reg-username" placeholder="Имя пользователя" required>
            <input type="password" id="reg-password" placeholder="Пароль" required>
            <input type="password" id="reg-confirm" placeholder="Подтвердите пароль" required>
            <button id="reg-btn">Зарегистрироваться</button>
            <div class="auth-switch" id="switch-to-login">Уже есть аккаунт? Войти</div>
        </div>
    </div>

    <div id="game-container" class="container" style="display: none;">
        <div class="settings-btn" id="settings-btn">⚙️</div>
        <div class="user-info" id="user-info">
            <div class="user-avatar" id="user-avatar">😀</div>
            <span id="username-display">User</span>
        </div>
        <h1>🎁 Симулятор открытия боксов со смайликами 🎁</h1>
        
        <div class="tabs">
            <div class="tab active" data-tab="game">Игра</div>
            <div class="tab" data-tab="games">Игры</div>
            <div class="tab" data-tab="creator">Креатор</div>
            <div class="tab" data-tab="quests">Квесты</div>
            <div class="tab" data-tab="collection">Коллекция</div>
            <div class="tab" data-tab="rates">Шансы</div>
        </div>
        
        <div class="tab-content active" id="game-tab">
            <div class="stats">
                <div class="stat-item">
                    <span>Монеты</span>
                    <span class="stat-value" id="coins">0</span>
                </div>
                <div class="stat-item">
                    <span>Открыто боксов</span>
                    <span class="stat-value" id="boxes-opened">0</span>
                </div>
                <div class="stat-item">
                    <span>Уникальных смайлов</span>
                    <span class="stat-value" id="unique-emojis">0</span>
                </div>
            </div>
            
            <div class="box-section">
                <div class="box-container">
                    <div class="box" id="box">
                        <div class="box-face box-top"></div>
                        <div class="box-face box-front"></div>
                        <div class="box-face box-back"></div>
                        <div class="box-face box-left"></div>
                        <div class="box-face box-right"></div>
                        <div class="box-face box-bottom"></div>
                        
                        <div class="box-lid">
                            <div class="box-face lid-top"></div>
                            <div class="box-face lid-front"></div>
                            <div class="box-face lid-back"></div>
                            <div class="box-face lid-left"></div>
                            <div class="box-face lid-right"></div>
                        </div>
                    </div>
                    <div class="box-glow" id="box-glow"></div>
                    <div class="box-sparkles" id="box-sparkles"></div>
                </div>
                
                <button class="open-btn" id="open-btn">Открыть бокс (10 монет)</button>
                
                <div class="result" id="result"></div>
            </div>
        </div>
        
        <div class="tab-content" id="games-tab">
            <div class="inventory">
                <h2>🎮 Мини-игры</h2>
                <div class="games-container">
                    <div class="game-selection">
                        <div class="game-card" data-game="find-emoji">
                            <div class="game-icon">🔍</div>
                            <div class="game-title">Найди смайлик</div>
                            <div class="game-reward">Награда: 100 монет</div>
                            <div class="game-description">Найдите отличающийся смайлик среди одинаковых</div>
                        </div>
                        
                        <div class="game-card" data-game="smile-clicker">
                            <div class="game-icon">🖱️</div>
                            <div class="game-title">Смайл Кликер</div>
                            <div class="game-reward">Награда: 10 монет за смайл</div>
                            <div class="game-description">Кликайте на появляющиеся смайлики за 30 секунд</div>
                        </div>
                        
                        <div class="game-card" data-game="memory">
                            <div class="game-icon">🧠</div>
                            <div class="game-title">Найди пару</div>
                            <div class="game-reward">Награда: 400 монет</div>
                            <div class="game-description">Найдите все пары одинаковых смайликов</div>
                        </div>

                        <div class="game-card" data-game="shooting">
                            <div class="game-icon">🎯</div>
                            <div class="game-title">Тир</div>
                            <div class="game-reward">Награда: 100 монет за 10 попаданий</div>
                            <div class="game-description">Стреляйте смайлами по мишеням</div>
                        </div>

                        <div class="game-card" data-game="boss">
                            <div class="game-icon">👹</div>
                            <div class="game-title">Против босса</div>
                            <div class="game-reward">Награда: 400 монет</div>
                            <div class="game-description">Уклоняйтесь от атак босса 1 минуту</div>
                        </div>
                    </div>
                    
                    <!-- Контейнеры для игр -->
                    <div id="find-emoji-game" class="find-emoji-game" style="display: none;">
                        <div class="game-info">
                            <div class="level-info">Уровень: <span id="current-level">1</span>/3</div>
                            <div class="timer">Время: <span id="game-timer">15</span>с</div>
                            <div>Найдите: <span class="target-emoji" id="target-emoji">😃</span></div>
                        </div>
                        <div class="emoji-grid" id="emoji-grid"></div>
                        <div class="game-result" id="game-result"></div>
                        <button class="open-btn" id="back-to-games">← Назад к играм</button>
                    </div>
                    
                    <div id="smile-clicker-game" class="clicker-game" style="display: none;">
                        <div class="clicker-timer">Время: <span id="clicker-timer">30</span>с</div>
                        <div class="clicker-score">Очки: <span id="clicker-score">0</span></div>
                        <div class="clicker-area" id="clicker-area"></div>
                        <div class="game-result" id="clicker-result"></div>
                        <button class="open-btn" id="back-to-games-2">← Назад к играм</button>
                    </div>
                    
                    <div id="memory-game" class="memory-game" style="display: none;">
                        <div class="memory-info">
                            <div>Найдите все пары одинаковых смайликов!</div>
                            <div class="timer">Пар найдено: <span id="pairs-found">0</span>/15</div>
                        </div>
                        <div class="memory-grid" id="memory-grid"></div>
                        <div class="memory-complete" id="memory-complete" style="display: none;">
                            🎉 Все пары найдены! +400 монет
                        </div>
                        <button class="open-btn" id="back-to-games-3">← Назад к играм</button>
                    </div>

                    <div id="shooting-game" class="shooting-game" style="display: none;">
                        <div class="shooting-info">
                            <div>Стреляйте по мишеням!</div>
                            <div class="timer">Попадания: <span id="hits-count">0</span>/10</div>
                        </div>
                        <div class="shooting-range" id="shooting-range"></div>
                        <div class="game-result" id="shooting-result"></div>
                        <button class="open-btn" id="back-to-games-4">← Назад к играм</button>
                    </div>

                    <div id="boss-game" class="boss-game" style="display: none;">
                        <div class="joystick-container" id="joystick-container">
                            <div class="joystick" id="joystick">
                                <div class="joystick-handle" id="joystick-handle"></div>
                            </div>
                        </div>
                        <div class="control-panel" id="control-panel">
                            <div class="control-row">
                                <div class="control-btn" id="up-btn">↑</div>
                            </div>
                            <div class="control-row">
                                <div class="control-btn" id="left-btn">←</div>
                                <div class="control-btn" id="down-btn">↓</div>
                                <div class="control-btn" id="right-btn">→</div>
                            </div>
                        </div>
                        <div class="boss-info">
                            <div>Уклоняйтесь от атак босса!</div>
                            <div class="timer">Время: <span id="boss-timer">60</span>с</div>
                        </div>
                        <div class="boss-arena" id="boss-arena">
                            <div class="boss">👹</div>
                            <div class="player">😎</div>
                        </div>
                        <div class="game-result" id="boss-result"></div>
                        <button class="open-btn" id="back-to-games-5">← Назад к играм</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="creator-tab">
            <div class="inventory">
                <h2>🎨 Креатор смайлов</h2>
                <div class="creator-container">
                    <div class="creator-cost">Стоимость создания: 5,000 монет</div>
                    
                    <div class="creator-preview">
                        <div class="custom-emoji" id="custom-emoji">
                            <div class="emoji-face">
                                <div class="emoji-eyes">
                                    <div class="eye"></div>
                                    <div class="eye"></div>
                                </div>
                                <div class="emoji-mouth"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="creator-options">
                        <div class="option-group">
                            <h3>Рот</h3>
                            <div class="option-buttons" id="mouth-options">
                                <button class="option-btn active" data-mouth="smile">Улыбка</button>
                                <button class="option-btn" data-mouth="sad">Грусть</button>
                                <button class="option-btn" data-mouth="none">Без рта</button>
                                <button class="option-btn" data-mouth="neutral">Без эмоций</button>
                            </div>
                        </div>

                        <div class="option-group">
                            <h3>Цвет рта</h3>
                            <div class="option-buttons" id="mouth-color-options">
                                <button class="option-btn active" data-mouth-color="black">Черный</button>
                                <button class="option-btn" data-mouth-color="red">Красный</button>
                                <button class="option-btn" data-mouth-color="blue">Синий</button>
                                <button class="option-btn" data-mouth-color="rainbow">Радужный</button>
                                <button class="option-btn" data-mouth-color="custom">Собственный</button>
                            </div>
                            <input type="color" class="color-picker" id="mouth-color-picker" style="display: none;">
                        </div>
                        
                        <div class="option-group">
                            <h3>Глаза</h3>
                            <div class="option-buttons" id="eyes-options">
                                <button class="option-btn active" data-eyes="big">Большие</button>
                                <button class="option-btn" data-eyes="small">Маленькие</button>
                                <button class="option-btn" data-eyes="narrow">Узкие</button>
                                <button class="option-btn" data-eyes="wide">Широкие</button>
                                <button class="option-btn" data-eyes="glowing">Светящиеся</button>
                            </div>
                        </div>

                        <div class="option-group">
                            <h3>Цвет глаз</h3>
                            <div class="option-buttons" id="eye-color-options">
                                <button class="option-btn active" data-eye-color="black">Черные</button>
                                <button class="option-btn" data-eye-color="blue">Синие</button>
                                <button class="option-btn" data-eye-color="green">Зеленые</button>
                                <button class="option-btn" data-eye-color="red">Красные</button>
                                <button class="option-btn" data-eye-color="custom">Собственный</button>
                            </div>
                            <input type="color" class="color-picker" id="eye-color-picker" style="display: none;">
                        </div>
                        
                        <div class="option-group">
                            <h3>Цвет кожи</h3>
                            <div class="option-buttons" id="skin-options">
                                <button class="option-btn active" data-skin="white">Белая</button>
                                <button class="option-btn" data-skin="black">Черная</button>
                                <button class="option-btn" data-skin="rainbow">Радужная</button>
                                <button class="option-btn" data-skin="shiny">Переливающаяся</button>
                                <button class="option-btn" data-skin="custom">Собственный</button>
                            </div>
                            <input type="color" class="color-picker" id="skin-color" style="display: none;">
                        </div>
                    </div>
                    
                    <button class="create-btn" id="create-emoji-btn" disabled>Создать смайл за 5,000 монет</button>
                    <div id="creator-result"></div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="quests-tab">
            <div class="inventory">
                <h2>📋 Ежедневные квесты</h2>
                <div class="quests-container">
                    <div class="quests-grid" id="quests-grid">
                        <!-- Квесты будут добавлены через JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="collection-tab">
            <div class="inventory">
                <h2>📚 Ваша коллекция смайлов</h2>
                <div id="inventory-container">
                    <!-- Категории смайлов будут добавлены через JavaScript -->
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="rates-tab">
            <div class="inventory">
                <h2>📊 Шансы выпадения</h2>
                <table class="rates-table">
                    <thead>
                        <tr>
                            <th>Категория</th>
                            <th>Шанс</th>
                        </tr>
                    </thead>
                    <tbody id="rates-table-body">
                        <!-- Данные о шансах будут добавлены через JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Модальное окно настроек -->
    <div class="settings-modal" id="settings-modal">
        <div class="settings-content">
            <button class="close-settings" id="close-settings">×</button>
            <h2>⚙️ Настройки</h2>
            
            <div class="settings-section">
                <h3>🔊 Музыка</h3>
                <div class="volume-control">
                    <span>Громкость:</span>
                    <input type="range" min="0" max="100" value="50" class="volume-slider" id="music-volume">
                    <span id="volume-value">50%</span>
                </div>
                <button id="toggle-music" class="account-btn">Выключить музыку</button>
            </div>
            
            <div class="settings-section">
                <h3>👥 Управление аккаунтами</h3>
                <div class="account-list" id="account-list">
                    <!-- Список аккаунтов будет добавлен через JavaScript -->
                </div>
                <button id="logout-btn" class="account-btn logout" style="margin-top: 15px; width: 100%;">
                    Выйти из текущего аккаунта
                </button>
            </div>
            
            <div class="settings-section">
                <h3>👤 Редактор профиля</h3>
                <div class="profile-form">
                    <input type="text" id="profile-username" placeholder="Новое имя пользователя">
                    <input type="password" id="profile-password" placeholder="Новый пароль">
                    <input type="password" id="profile-confirm" placeholder="Подтвердите новый пароль">
                    <button id="save-profile-btn">Сохранить изменения</button>
                </div>
                <div class="avatar-selection">
                    <h3>Выберите аватар:</h3>
                    <div class="avatar-options" id="avatar-options">
                        <!-- Аватары будут добавлены через JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно предпросмотра квеста -->
    <div class="quest-preview-modal" id="quest-preview-modal">
        <div class="quest-preview-content">
            <button class="close-quest-preview" id="close-quest-preview">×</button>
            <h2 id="quest-preview-title">Предпросмотр квеста</h2>
            <div class="quest-preview-emoji" id="quest-preview-emoji"></div>
            <div id="quest-preview-description"></div>
            <div id="quest-preview-reward"></div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>

    <script>
        // Версия игры
        const GAME_VERSION = "0.5.2";

        // База данных смайлов по категориям
        const emojiDatabase = {
            faces: ["😀", "😃", "😄", "😁", "😆", "😅", "😂", "🤣", "😊", "😇", "🙂", "🙃", "😉", "😌", "😍", "🥰", "😘", "😗", "😙", "😚", "😋", "😛", "😝", "😜", "🤪", "🤨", "🧐", "🤓", "😎", "🤩"],
            nature: ["🐻", "☘", "🌱", "🌲", "🌳", "🌴", "🌵", "🌷", "🌸", "🌹", "🌺", "🌻", "🌼", "💐", "🌾", "🌿", "🍀", "🍁", "🍂", "🍃", "🐶", "🐱", "🐭", "🐹", "🐰", "🦊", "🐻", "🐼", "🐨", "🐯"],
            food: ["🍏", "🍎", "🍐", "🍊", "🍋", "🍌", "🍉", "🍇", "🍓", "🍈", "🍒", "🍑", "🍍", "🥥", "🥝", "🍅", "🍆", "🥑", "🥦", "🥬", "🥒", "🌶", "🌽", "🥕", "🧄", "🧅", "🍕", "🍔", "🍟", "🌭"],
            games: ["🏀", "🏈", "⚽", "⚾", "🎾", "🏐", "🏉", "🎱", "🪀", "🏓", "🏸", "🏒", "🏑", "🏏", "⛳", "🪁", "🏹", "🎣", "🤿", "🥊", "🥋", "🎽", "🛹", "🛷", "🎮", "👾", "🕹", "🎯", "🎳", "🎲"],
            travel: ["🚗", "🏜", "🚙", "🚌", "🚎", "🏎", "🚓", "🚑", "🚒", "🚐", "🚚", "🚛", "🚜", "🏍", "🛵", "🚲", "🛴", "🚁", "✈", "🛩", "🛫", "🪂", "💺", "🚀", "🛸", "🚉", "🚊", "🚝", "🚄", "🚂"],
            tech: ["💻", "📱", "⌚", "📷", "📹", "🎥", "📺", "📻", "💾", "💿", "📀", "📼", "🔋", "🔌", "💡", "🔦", "🕯", "🧯", "💰", "💳", "🖥", "⌨", "🖱", "📞", "📠", "📡", "🛜", "💽", "🗜", "🔧"],
            symbols: ["❤", "🎵", "🔞", "💯", "💢", "💬", "💭", "♨", "💤", "💮", "💥", "💫", "💦", "💨", "🕳", "💣", "👁", "🗨", "💭", "💤", "🌐", "♻", "📛", "⭕", "❌", "💢", "♦", "♥", "♠", "♣"]
        };

        // Анимированный медведь (CSS-реализация)
        const animatedBear = "polar-bear";

        // Анимированная тыква (CSS-реализация)
        const animatedPumpkin = "pumpkin";

        // Пары для игры "Найди смайлик"
        const findEmojiPairs = {
            easy: [
                { common: "😗", target: "😙" },
                { common: "😀", target: "😃" },
                { common: "🤓", target: "😎" },
                { common: "😊", target: "😇" },
                { common: "🙂", target: "🙃" }
            ],
            medium: [
                { common: "😋", target: "😛" },
                { common: "😜", target: "😝" },
                { common: "🐱", target: "🐯" },
                { common: "🌷", target: "🌹" },
                { common: "🍎", target: "🍏" }
            ],
            hard: [
                { common: "❤", target: "💖" },
                { common: "⭐", target: "🌟" },
                { common: "💎", target: "🔮" },
                { common: "🎯", target: "🏆" },
                { common: "🚗", target: "🏎" }
            ]
        };

        // Шансы выпадения (обновленные)
        const dropRates = {
            faces: 40,
            nature: 10,
            food: 10,
            games: 10,
            travel: 10,
            tech: 10,
            symbols: 8,
            unique: 2.999999999,
            disappear: 0.000000001
        };

        // Квесты
        const availableQuests = [
            { id: "faces5", type: "emoji", category: "faces", target: 5, reward: 300, description: "Выбей 5 смайлов лиц" },
            { id: "nature5", type: "emoji", category: "nature", target: 5, reward: 300, description: "Выбей 5 смайлов природа" },
            { id: "food5", type: "emoji", category: "food", target: 5, reward: 300, description: "Выбей 5 смайлов еда" },
            { id: "games5", type: "emoji", category: "games", target: 5, reward: 300, description: "Выбей 5 смайлов игры" },
            { id: "travel5", type: "emoji", category: "travel", target: 5, reward: 300, description: "Выбей 5 смайлов туризм и машина" },
            { id: "tech5", type: "emoji", category: "tech", target: 5, reward: 300, description: "Выбей 5 смайлов техника" },
            { id: "symbols3", type: "emoji", category: "symbols", target: 3, reward: 300, description: "Выбей 3 смайлов знаки" },
            { id: "unique1", type: "unique", target: 1, reward: 300, description: "Выбей 1 уникальный смайл" },
            { id: "open10", type: "open", target: 10, reward: 100, description: "Открой бокс 10 раз" },
            { id: "find5", type: "play", game: "find-emoji", target: 5, reward: 500, description: "Сыграй 5 раз в игру: 'Найди Смайл'" },
            { id: "find10", type: "play", game: "find-emoji", target: 10, reward: 1000, description: "Сыграй 10 раз в игру: 'Найди Смайл'" },
            { id: "find12", type: "play", game: "find-emoji", target: 12, reward: 1200, description: "Сыграй 12 раз в игру: 'Найди Смайл'" },
            { id: "clicker5", type: "play", game: "smile-clicker", target: 5, reward: 500, description: "Сыграй 5 раз в игру: 'Смайл Кликер'" },
            { id: "clicker10", type: "play", game: "smile-clicker", target: 10, reward: 1000, description: "Сыграй 10 раз в игру: 'Смайл Кликер'" },
            { id: "clicker12", type: "play", game: "smile-clicker", target: 12, reward: 1200, description: "Сыграй 12 раз в игру: 'Смайл Кликер'" },
            { id: "memory3", type: "play", game: "memory", target: 3, reward: 500, description: "Сыграй 3 раз в игру: 'Найди пару'" },
            { id: "memory6", type: "play", game: "memory", target: 6, reward: 1000, description: "Сыграй 6 раз в игру: 'Найди пару'" },
            { id: "memory8", type: "play", game: "memory", target: 8, reward: 1200, description: "Сыграй 8 раз в игру: 'Найди пару'" },
            { id: "shooting5", type: "play", game: "shooting", target: 5, reward: 500, description: "Сыграй 5 раз в игру: 'Тир'" },
            { id: "shooting10", type: "play", game: "shooting", target: 10, reward: 1000, description: "Сыграй 10 раз в игру: 'Тир'" },
            { id: "shooting12", type: "play", game: "shooting", target: 12, reward: 1200, description: "Сыграй 12 раз в игру: 'Тир'" },
            { id: "boss3", type: "play", game: "boss", target: 3, reward: 700, description: "Сыграй 3 раз в игру: 'Против босса'" },
            { id: "boss6", type: "play", game: "boss", target: 6, reward: 1200, description: "Сыграй 6 раз в игру: 'Против босса'" },
            { id: "boss8", type: "play", game: "boss", target: 8, reward: 1500, description: "Сыграй 8 раз в игру: 'Против босса'" }
        ];

        // Специальные квесты
        const specialQuests = [
            {
                id: "bear150", 
                type: "special", 
                target: 150, 
                reward: animatedBear, 
                description: "Открой бокс 150 раз",
                special: true
            },
            {
                id: "pumpkin200", 
                type: "special", 
                target: 200, 
                reward: animatedPumpkin, 
                description: "Открой бокс 200 раз",
                special: true
            }
        ];

        // Игровые данные
        let gameData = {
            coins: 0,
            boxesOpened: 0,
            ownedEmojis: {
                faces: [],
                nature: [],
                food: [],
                games: [],
                travel: [],
                tech: [],
                symbols: [],
                unique: [],
                custom: []
            },
            gameStats: {
                "find-emoji": { plays: 0, wins: 0 },
                "smile-clicker": { plays: 0, score: 0 },
                "memory": { plays: 0, completes: 0 },
                "shooting": { plays: 0, hits: 0 },
                "boss": { plays: 0, wins: 0 }
            },
            quests: {
                daily: [],
                progress: {},
                completed: [],
                lastUpdate: null
            },
            dailyBonus: {
                lastClaim: null,
                streak: 0
            },
            profile: {
                avatar: "😀",
                username: ""
            },
            creator: {
                mouth: "smile",
                mouthColor: "black",
                eyes: "big",
                eyeColor: "black",
                skin: "white",
                customColor: "#ffcc00",
                eyeCustomColor: "#000000",
                mouthCustomColor: "#000000"
            }
        };

        // Текущий пользователь
        let currentUser = null;

        // Переменные для игр
        let gameTimer = null;
        let gameTimeLeft = 0;
        let currentGamePair = null;
        let gameActive = false;
        let currentLevel = 1;
        let currentRoundPairs = [];

        // Кликер игра
        let clickerScore = 0;
        let clickerEmojis = [];

        // Memory игра
        let memoryCards = [];
        let selectedCards = [];
        let matchedPairs = 0;
        let totalPairs = 15;

        // Shooting игра
        let hitsCount = 0;
        let targets = [];
        let bullets = [];

        // Boss игра
        let bossTimeLeft = 60;
        let playerPosition = { x: 300, y: 350 };
        let projectiles = [];
        let gameInterval = null;
        let keys = {};
        let joystickActive = false;
        let joystickDirection = { x: 0, y: 0 };
        let lastProjectileTime = 0;
        const PROJECTILE_INTERVAL = 800; // 800ms между снарядами

        // Музыка
        let backgroundMusic = null;
        let bossMusic = null;
        let musicVolume = 0.5;
        let musicEnabled = true;

        // Элементы DOM
        const authContainer = document.getElementById('auth-container');
        const gameContainer = document.getElementById('game-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const userInfoElement = document.getElementById('user-info');
        const userAvatarElement = document.getElementById('user-avatar');
        const usernameDisplayElement = document.getElementById('username-display');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');
        const boxElement = document.getElementById('box');
        const boxGlowElement = document.getElementById('box-glow');
        const boxSparklesElement = document.getElementById('box-sparkles');
        const openButton = document.getElementById('open-btn');
        const resultElement = document.getElementById('result');
        const coinsElement = document.getElementById('coins');
        const boxesOpenedElement = document.getElementById('boxes-opened');
        const uniqueEmojisElement = document.getElementById('unique-emojis');
        const inventoryContainer = document.getElementById('inventory-container');
        const notificationElement = document.getElementById('notification');
        const ratesTableBody = document.getElementById('rates-table-body');
        const gameTimerElement = document.getElementById('game-timer');
        const targetEmojiElement = document.getElementById('target-emoji');
        const emojiGridElement = document.getElementById('emoji-grid');
        const gameResultElement = document.getElementById('game-result');
        const currentLevelElement = document.getElementById('current-level');
        const profileUsernameInput = document.getElementById('profile-username');
        const profilePasswordInput = document.getElementById('profile-password');
        const profileConfirmInput = document.getElementById('profile-confirm');
        const saveProfileButton = document.getElementById('save-profile-btn');
        const avatarOptionsElement = document.getElementById('avatar-options');
        const musicVolumeSlider = document.getElementById('music-volume');
        const volumeValueElement = document.getElementById('volume-value');
        const toggleMusicButton = document.getElementById('toggle-music');
        const accountListElement = document.getElementById('account-list');
        const logoutButton = document.getElementById('logout-btn');
        const questsGrid = document.getElementById('quests-grid');
        const gameCards = document.querySelectorAll('.game-card');
        const backToGamesButtons = document.querySelectorAll('[id^="back-to-games"]');
        const memoryGrid = document.getElementById('memory-grid');
        const pairsFoundElement = document.getElementById('pairs-found');
        const memoryCompleteElement = document.getElementById('memory-complete');
        const shootingRange = document.getElementById('shooting-range');
        const hitsCountElement = document.getElementById('hits-count');
        const shootingResult = document.getElementById('shooting-result');
        const bossArena = document.getElementById('boss-arena');
        const bossTimerElement = document.getElementById('boss-timer');
        const bossResult = document.getElementById('boss-result');
        const customEmoji = document.getElementById('custom-emoji');
        const mouthOptions = document.getElementById('mouth-options');
        const mouthColorOptions = document.getElementById('mouth-color-options');
        const mouthColorPicker = document.getElementById('mouth-color-picker');
        const eyesOptions = document.getElementById('eyes-options');
        const eyeColorOptions = document.getElementById('eye-color-options');
        const eyeColorPicker = document.getElementById('eye-color-picker');
        const skinOptions = document.getElementById('skin-options');
        const skinColorPicker = document.getElementById('skin-color');
        const createEmojiBtn = document.getElementById('create-emoji-btn');
        const creatorResult = document.getElementById('creator-result');
        const joystickContainer = document.getElementById('joystick-container');
        const joystick = document.getElementById('joystick');
        const joystickHandle = document.getElementById('joystick-handle');
        const questPreviewModal = document.getElementById('quest-preview-modal');
        const closeQuestPreview = document.getElementById('close-quest-preview');
        const questPreviewEmoji = document.getElementById('quest-preview-emoji');
        const questPreviewDescription = document.getElementById('quest-preview-description');
        const questPreviewReward = document.getElementById('quest-preview-reward');
        const questPreviewTitle = document.getElementById('quest-preview-title');
        const controlPanel = document.getElementById('control-panel');
        const upBtn = document.getElementById('up-btn');
        const downBtn = document.getElementById('down-btn');
        const leftBtn = document.getElementById('left-btn');
        const rightBtn = document.getElementById('right-btn');

        // Инициализация игры
        function initGame() {
            console.log("Инициализация игры...");
            setupAuth();
            setupTabs();
            setupGames();
            setupSettings();
            setupCreator();
            renderRatesTable();
            setupProfileEditor();
            setupMusic();
            setupJoystick();
            setupQuestPreview();
            setupControlPanel();
            
            // Обработчик открытия бокса
            openButton.addEventListener('click', openBox);
            
            console.log("Игра инициализирована!");
        }

        // Настройка панели управления для игры с боссом
        function setupControlPanel() {
            // Обработчики для кнопок управления
            upBtn.addEventListener('mousedown', () => keys['w'] = true);
            upBtn.addEventListener('mouseup', () => keys['w'] = false);
            upBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys['w'] = true;
            });
            upBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys['w'] = false;
            });

            downBtn.addEventListener('mousedown', () => keys['s'] = true);
            downBtn.addEventListener('mouseup', () => keys['s'] = false);
            downBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys['s'] = true;
            });
            downBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys['s'] = false;
            });

            leftBtn.addEventListener('mousedown', () => keys['a'] = true);
            leftBtn.addEventListener('mouseup', () => keys['a'] = false);
            leftBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys['a'] = true;
            });
            leftBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys['a'] = false;
            });

            rightBtn.addEventListener('mousedown', () => keys['d'] = true);
            rightBtn.addEventListener('mouseup', () => keys['d'] = false);
            rightBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                keys['d'] = true;
            });
            rightBtn.addEventListener('touchend', (e) => {
                e.preventDefault();
                keys['d'] = false;
            });
        }

        // Настройка предпросмотра квестов
        function setupQuestPreview() {
            closeQuestPreview.addEventListener('click', () => {
                questPreviewModal.style.display = 'none';
            });
        }

        // Настройка джойстика
        function setupJoystick() {
            let joystickBounds = joystick.getBoundingClientRect();
            let joystickCenterX = joystickBounds.left + joystickBounds.width / 2;
            let joystickCenterY = joystickBounds.top + joystickBounds.height / 2;
            let joystickRadius = joystickBounds.width / 2;

            function updateJoystickPosition(clientX, clientY) {
                const deltaX = clientX - joystickCenterX;
                const deltaY = clientY - joystickCenterY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                if (distance < joystickRadius) {
                    joystickHandle.style.transform = `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY}px))`;
                    joystickDirection.x = deltaX / joystickRadius;
                    joystickDirection.y = deltaY / joystickRadius;
                } else {
                    const angle = Math.atan2(deltaY, deltaX);
                    const limitedX = Math.cos(angle) * joystickRadius;
                    const limitedY = Math.sin(angle) * joystickRadius;
                    
                    joystickHandle.style.transform = `translate(calc(-50% + ${limitedX}px), calc(-50% + ${limitedY}px))`;
                    joystickDirection.x = limitedX / joystickRadius;
                    joystickDirection.y = limitedY / joystickRadius;
                }
            }

            // Обработчики для касаний
            joystick.addEventListener('touchstart', (e) => {
                e.preventDefault();
                joystickActive = true;
                joystickBounds = joystick.getBoundingClientRect();
                joystickCenterX = joystickBounds.left + joystickBounds.width / 2;
                joystickCenterY = joystickBounds.top + joystickBounds.height / 2;
                joystickRadius = joystickBounds.width / 2;
                
                updateJoystickPosition(e.touches[0].clientX, e.touches[0].clientY);
            });

            document.addEventListener('touchmove', (e) => {
                if (joystickActive) {
                    e.preventDefault();
                    updateJoystickPosition(e.touches[0].clientX, e.touches[0].clientY);
                }
            });

            document.addEventListener('touchend', () => {
                joystickActive = false;
                joystickHandle.style.transform = 'translate(-50%, -50%)';
                joystickDirection.x = 0;
                joystickDirection.y = 0;
            });

            // Обработчики для мыши (для тестирования на ПК)
            joystick.addEventListener('mousedown', (e) => {
                joystickActive = true;
                joystickBounds = joystick.getBoundingClientRect();
                joystickCenterX = joystickBounds.left + joystickBounds.width / 2;
                joystickCenterY = joystickBounds.top + joystickBounds.height / 2;
                joystickRadius = joystickBounds.width / 2;
                
                updateJoystickPosition(e.clientX, e.clientY);
            });

            document.addEventListener('mousemove', (e) => {
                if (joystickActive) {
                    updateJoystickPosition(e.clientX, e.clientY);
                }
            });

            document.addEventListener('mouseup', () => {
                joystickActive = false;
                joystickHandle.style.transform = 'translate(-50%, -50%)';
                joystickDirection.x = 0;
                joystickDirection.y = 0;
            });
        }

        // Настройка игр
        function setupGames() {
            // Обработчики для карточек игр
            gameCards.forEach(card => {
                card.addEventListener('click', () => {
                    const game = card.dataset.game;
                    startGame(game);
                });
            });

            // Обработчики для кнопок "Назад"
            backToGamesButtons.forEach(btn => {
                btn.addEventListener('click', showGameSelection);
            });
        }

        // Настройка креатора
        function setupCreator() {
            // Обработчики для опций рта
            mouthOptions.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    mouthOptions.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameData.creator.mouth = btn.dataset.mouth;
                    updateCustomEmoji();
                });
            });

            // Обработчики для цвета рта
            mouthColorOptions.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    mouthColorOptions.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameData.creator.mouthColor = btn.dataset.mouthColor;
                    
                    if (btn.dataset.mouthColor === 'custom') {
                        mouthColorPicker.style.display = 'block';
                    } else {
                        mouthColorPicker.style.display = 'none';
                    }
                    
                    updateCustomEmoji();
                });
            });

            // Обработчик для выбора цвета рта
            mouthColorPicker.addEventListener('input', (e) => {
                gameData.creator.mouthCustomColor = e.target.value;
                updateCustomEmoji();
            });

            // Обработчики для опций глаз
            eyesOptions.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    eyesOptions.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameData.creator.eyes = btn.dataset.eyes;
                    updateCustomEmoji();
                });
            });

            // Обработчики для цвета глаз
            eyeColorOptions.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    eyeColorOptions.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameData.creator.eyeColor = btn.dataset.eyeColor;
                    
                    if (btn.dataset.eyeColor === 'custom') {
                        eyeColorPicker.style.display = 'block';
                    } else {
                        eyeColorPicker.style.display = 'none';
                    }
                    
                    updateCustomEmoji();
                });
            });

            // Обработчик для выбора цвета глаз
            eyeColorPicker.addEventListener('input', (e) => {
                gameData.creator.eyeCustomColor = e.target.value;
                updateCustomEmoji();
            });

            // Обработчики для опций кожи
            skinOptions.querySelectorAll('.option-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    skinOptions.querySelectorAll('.option-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    gameData.creator.skin = btn.dataset.skin;
                    
                    if (btn.dataset.skin === 'custom') {
                        skinColorPicker.style.display = 'block';
                    } else {
                        skinColorPicker.style.display = 'none';
                    }
                    
                    updateCustomEmoji();
                });
            });

            // Обработчик для выбора цвета кожи
            skinColorPicker.addEventListener('input', (e) => {
                gameData.creator.customColor = e.target.value;
                updateCustomEmoji();
            });

            // Обработчик для создания смайла
            createEmojiBtn.addEventListener('click', createCustomEmoji);

            // Обновляем кнопку создания
            updateCreateButton();
        }

        // Обновление кастомного смайла
        function updateCustomEmoji() {
            const face = customEmoji.querySelector('.emoji-face');
            const eyes = face.querySelector('.emoji-eyes');
            const mouth = face.querySelector('.emoji-mouth');
            
            // Очищаем предыдущие стили
            customEmoji.style.background = '';
            customEmoji.style.animation = '';
            eyes.innerHTML = '';
            mouth.style.background = '';
            mouth.style.borderRadius = '';
            mouth.style.transform = '';
            mouth.style.display = 'block';
            mouth.style.animation = '';
            
            // Устанавливаем цвет кожи
            switch(gameData.creator.skin) {
                case 'white':
                    customEmoji.style.background = '#ffdbac';
                    break;
                case 'black':
                    customEmoji.style.background = '#8d5524';
                    break;
                case 'rainbow':
                    customEmoji.style.background = 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)';
                    customEmoji.style.backgroundSize = '200% 200%';
                    customEmoji.style.animation = 'rainbow-shift 3s infinite linear';
                    break;
                case 'shiny':
                    customEmoji.style.background = 'linear-gradient(135deg, #ffcc00, #ff9900, #ffcc00)';
                    customEmoji.style.backgroundSize = '200px 100%';
                    customEmoji.style.animation = 'shine 2s infinite linear';
                    break;
                case 'custom':
                    customEmoji.style.background = gameData.creator.customColor;
                    break;
            }
            
            // Устанавливаем глаза
            const leftEye = document.createElement('div');
            const rightEye = document.createElement('div');
            leftEye.className = 'eye';
            rightEye.className = 'eye';
            
            // Устанавливаем цвет глаз
            let eyeColorValue;
            switch(gameData.creator.eyeColor) {
                case 'black':
                    eyeColorValue = '#000000';
                    break;
                case 'blue':
                    eyeColorValue = '#0000ff';
                    break;
                case 'green':
                    eyeColorValue = '#00ff00';
                    break;
                case 'red':
                    eyeColorValue = '#ff0000';
                    break;
                case 'custom':
                    eyeColorValue = gameData.creator.eyeCustomColor;
                    break;
                default:
                    eyeColorValue = '#000000';
            }
            
            leftEye.style.background = eyeColorValue;
            rightEye.style.background = eyeColorValue;
            
            switch(gameData.creator.eyes) {
                case 'big':
                    leftEye.style.width = '16px';
                    leftEye.style.height = '16px';
                    rightEye.style.width = '16px';
                    rightEye.style.height = '16px';
                    break;
                case 'small':
                    leftEye.style.width = '8px';
                    leftEye.style.height = '8px';
                    rightEye.style.width = '8px';
                    rightEye.style.height = '8px';
                    break;
                case 'narrow':
                    leftEye.style.width = '20px';
                    leftEye.style.height = '6px';
                    rightEye.style.width = '20px';
                    rightEye.style.height = '6px';
                    leftEye.style.borderRadius = '3px';
                    rightEye.style.borderRadius = '3px';
                    break;
                case 'wide':
                    leftEye.style.width = '10px';
                    leftEye.style.height = '10px';
                    rightEye.style.width = '10px';
                    rightEye.style.height = '10px';
                    eyes.style.justifyContent = 'space-between';
                    eyes.style.padding = '0 15px';
                    break;
                case 'glowing':
                    leftEye.style.width = '12px';
                    leftEye.style.height = '12px';
                    rightEye.style.width = '12px';
                    rightEye.style.height = '12px';
                    leftEye.style.boxShadow = `0 0 10px ${eyeColorValue}`;
                    rightEye.style.boxShadow = `0 0 10px ${eyeColorValue}`;
                    leftEye.style.animation = 'glow 1.5s infinite alternate';
                    rightEye.style.animation = 'glow 1.5s infinite alternate';
                    break;
            }
            
            eyes.appendChild(leftEye);
            eyes.appendChild(rightEye);
            
            // Устанавливаем рот
            let mouthColorValue;
            switch(gameData.creator.mouthColor) {
                case 'black':
                    mouthColorValue = '#000000';
                    break;
                case 'red':
                    mouthColorValue = '#ff0000';
                    break;
                case 'blue':
                    mouthColorValue = '#0000ff';
                    break;
                case 'rainbow':
                    mouthColorValue = 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)';
                    mouth.style.backgroundSize = '200% 200%';
                    mouth.style.animation = 'rainbow-shift 3s infinite linear';
                    break;
                case 'custom':
                    mouthColorValue = gameData.creator.mouthCustomColor;
                    break;
                default:
                    mouthColorValue = '#000000';
            }
            
            mouth.style.background = mouthColorValue;
            
            switch(gameData.creator.mouth) {
                case 'smile':
                    mouth.style.borderRadius = '0 0 15px 15px';
                    mouth.style.width = '30px';
                    mouth.style.height = '15px';
                    break;
                case 'sad':
                    mouth.style.borderRadius = '15px 15px 0 0';
                    mouth.style.width = '30px';
                    mouth.style.height = '15px';
                    mouth.style.transform = 'translateX(-50%) translateY(5px)';
                    break;
                case 'none':
                    mouth.style.display = 'none';
                    break;
                case 'neutral':
                    mouth.style.borderRadius = '0';
                    mouth.style.width = '30px';
                    mouth.style.height = '5px';
                    break;
            }
        }

        // Обновление кнопки создания
        function updateCreateButton() {
            if (gameData.coins >= 5000) {
                createEmojiBtn.disabled = false;
                createEmojiBtn.textContent = 'Создать смайл за 5,000 монет';
            } else {
                createEmojiBtn.disabled = true;
                createEmojiBtn.textContent = `Недостаточно монет (${gameData.coins}/5,000)`;
            }
        }

        // Создание кастомного смайла
        function createCustomEmoji() {
            if (gameData.coins < 5000) {
                showNotification("Недостаточно монет для создания смайла!");
                return;
            }
            
            gameData.coins -= 5000;
            
            // Создаем уникальный ID для кастомного смайла
            const customEmojiId = `custom-${Date.now()}`;
            
            // Сохраняем кастомный смайл
            gameData.ownedEmojis.custom.push(customEmojiId);
            
            // Сохраняем настройки кастомного смайла
            if (!gameData.customEmojis) {
                gameData.customEmojis = {};
            }
            gameData.customEmojis[customEmojiId] = { ...gameData.creator };
            
            updateStats();
            updateCreateButton();
            renderInventory();
            showNotification("🎉 Кастомный смайл успешно создан!");
            creatorResult.textContent = "Ваш уникальный смайл добавлен в коллекцию!";
            
            saveUserData();
        }

        // Настройка музыки
        function setupMusic() {
            backgroundMusic = document.getElementById('background-music');
            bossMusic = document.getElementById('boss-music');
            
            // Загружаем настройки музыки из localStorage
            const savedMusicSettings = localStorage.getItem('musicSettings');
            if (savedMusicSettings) {
                const settings = JSON.parse(savedMusicSettings);
                musicVolume = settings.volume || 0.5;
                musicEnabled = settings.enabled !== false;
            }
            
            // Устанавливаем громкость
            backgroundMusic.volume = musicVolume;
            bossMusic.volume = musicVolume;
            musicVolumeSlider.value = musicVolume * 100;
            volumeValueElement.textContent = Math.round(musicVolume * 100) + '%';
            
            // Включаем/выключаем музыку
            if (musicEnabled) {
                backgroundMusic.play().catch(e => console.log("Автовоспроизведение заблокировано:", e));
                toggleMusicButton.textContent = 'Выключить музыку';
            } else {
                toggleMusicButton.textContent = 'Включить музыку';
            }
            
            // Обработчики для управления музыкой
            musicVolumeSlider.addEventListener('input', updateMusicVolume);
            toggleMusicButton.addEventListener('click', toggleMusic);
        }

        // Обновление громкости музыки
        function updateMusicVolume() {
            musicVolume = musicVolumeSlider.value / 100;
            backgroundMusic.volume = musicVolume;
            bossMusic.volume = musicVolume;
            volumeValueElement.textContent = musicVolumeSlider.value + '%';
            
            // Сохраняем настройки
            saveMusicSettings();
        }

        // Включение/выключение музыки
        function toggleMusic() {
            musicEnabled = !musicEnabled;
            
            if (musicEnabled) {
                backgroundMusic.play().catch(e => console.log("Воспроизведение заблокировано:", e));
                toggleMusicButton.textContent = 'Выключить музыку';
            } else {
                backgroundMusic.pause();
                bossMusic.pause();
                toggleMusicButton.textContent = 'Включить музыку';
            }
            
            // Сохраняем настройки
            saveMusicSettings();
        }

        // Сохранение настроек музыки
        function saveMusicSettings() {
            const settings = {
                volume: musicVolume,
                enabled: musicEnabled
            };
            localStorage.setItem('musicSettings', JSON.stringify(settings));
        }

        // Настройка настроек
        function setupSettings() {
            settingsBtn.addEventListener('click', () => {
                settingsModal.style.display = 'block';
                renderAvatarOptions();
                updateAccountList();
            });

            closeSettings.addEventListener('click', () => {
                settingsModal.style.display = 'none';
            });

            logoutButton.addEventListener('click', logout);
        }

        // Настройка аутентификации
        function setupAuth() {
            console.log("Настройка аутентификации...");
            
            document.getElementById('auth-btn').addEventListener('click', login);
            document.getElementById('reg-btn').addEventListener('click', register);
            document.getElementById('switch-to-register').addEventListener('click', showRegisterForm);
            document.getElementById('switch-to-login').addEventListener('click', showLoginForm);
            
            // Проверяем, есть ли сохраненный пользователь
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    loadUserData();
                    showGame();
                    console.log("Пользователь авторизован:", currentUser.username);
                } catch (e) {
                    console.error("Ошибка загрузки пользователя:", e);
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // Настройка редактора профиля
        function setupProfileEditor() {
            console.log("Настройка редактора профиля...");
            saveProfileButton.addEventListener('click', saveProfile);
        }

        // Показать форму регистрации
        function showRegisterForm() {
            console.log("Показать форму регистрации");
            loginForm.style.display = 'none';
            registerForm.style.display = 'flex';
        }

        // Показать форму входа
        function showLoginForm() {
            console.log("Показать форму входа");
            registerForm.style.display = 'none';
            loginForm.style.display = 'flex';
        }

        // Вход в систему
        function login() {
            console.log("Попытка входа...");
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showNotification("Заполните все поля!");
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[username] && users[username].password === password) {
                currentUser = { username, password };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loadUserData();
                showGame();
                showNotification(`Добро пожаловать, ${username}!`);
                console.log("Успешный вход:", username);
                
                // Обновляем список аккаунтов
                updateAccountList();
            } else {
                showNotification("Неверное имя пользователя или пароль!");
            }
        }

        // Регистрация
        function register() {
            console.log("Попытка регистрации...");
            const username = document.getElementById('reg-username').value;
            const password = document.getElementById('reg-password').value;
            const confirm = document.getElementById('reg-confirm').value;
            
            if (!username || !password || !confirm) {
                showNotification("Заполните все поля!");
                return;
            }
            
            if (password !== confirm) {
                showNotification("Пароли не совпадают!");
                return;
            }
            
            if (password.length < 4) {
                showNotification("Пароль должен быть не менее 4 символов!");
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[username]) {
                showNotification("Пользователь с таким именем уже существует!");
                return;
            }
            
            users[username] = { password, createdAt: new Date().toISOString() };
            localStorage.setItem('users', JSON.stringify(users));
            
            currentUser = { username, password };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            // Создаем данные для нового пользователя
            gameData = {
                coins: 1000, // Начальные монеты
                boxesOpened: 0,
                ownedEmojis: {
                    faces: [],
                    nature: [],
                    food: [],
                    games: [],
                    travel: [],
                    tech: [],
                    symbols: [],
                    unique: [],
                    custom: []
                },
                gameStats: {
                    "find-emoji": { plays: 0, wins: 0 },
                    "smile-clicker": { plays: 0, score: 0 },
                    "memory": { plays: 0, completes: 0 },
                    "shooting": { plays: 0, hits: 0 },
                    "boss": { plays: 0, wins: 0 }
                },
                quests: {
                    daily: [],
                    progress: {},
                    completed: [],
                    lastUpdate: null
                },
                dailyBonus: {
                    lastClaim: new Date().toISOString(),
                    streak: 1
                },
                profile: {
                    avatar: "😀",
                    username: username
                },
                creator: {
                    mouth: "smile",
                    mouthColor: "black",
                    eyes: "big",
                    eyeColor: "black",
                    skin: "white",
                    customColor: "#ffcc00",
                    eyeCustomColor: "#000000",
                    mouthCustomColor: "#000000"
                }
            };
            
            // Генерируем ежедневные квесты
            generateDailyQuests();
            
            saveUserData();
            
            showGame();
            showNotification(`Аккаунт ${username} успешно создан! +1000 монет`);
            console.log("Успешная регистрация:", username);
            
            // Обновляем список аккаунтов
            updateAccountList();
        }

        // Выход из системы
        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showNotification("Вы вышли из системы");
            authContainer.style.display = 'block';
            gameContainer.style.display = 'none';
            settingsModal.style.display = 'none';
            
            // Очищаем поля ввода
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            
            // Обновляем список аккаунтов
            updateAccountList();
        }

        // Вход под другим аккаунтом
        function loginAsUser(username) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[username]) {
                currentUser = { username, password: users[username].password };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                loadUserData();
                showGame();
                showNotification(`Добро пожаловать, ${username}!`);
                settingsModal.style.display = 'none';
                
                // Обновляем список аккаунтов
                updateAccountList();
            }
        }

        // Обновление списка аккаунтов
        function updateAccountList() {
            accountListElement.innerHTML = '';
            
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const userList = Object.keys(users);
            
            if (userList.length === 0) {
                const noAccounts = document.createElement('div');
                noAccounts.textContent = "Нет сохраненных аккаунтов";
                noAccounts.style.color = '#aaa';
                noAccounts.style.padding = '10px';
                noAccounts.style.textAlign = 'center';
                accountListElement.appendChild(noAccounts);
                return;
            }
            
            userList.forEach(username => {
                const accountItem = document.createElement('div');
                accountItem.className = `account-item ${currentUser && username === currentUser.username ? 'current' : ''}`;
                
                const accountInfo = document.createElement('div');
                accountInfo.innerHTML = `
                    <strong>${username}</strong><br>
                    <small>Создан: ${new Date(users[username].createdAt).toLocaleDateString()}</small>
                `;
                
                const accountActions = document.createElement('div');
                accountActions.className = 'account-actions';
                
                if (currentUser && username === currentUser.username) {
                    const currentBadge = document.createElement('span');
                    currentBadge.textContent = 'Текущий';
                    currentBadge.style.background = '#4a90e2';
                    currentBadge.style.color = 'white';
                    currentBadge.style.padding = '4px 8px';
                    currentBadge.style.borderRadius = '4px';
                    currentBadge.style.fontSize = '12px';
                    accountActions.appendChild(currentBadge);
                } else {
                    const loginBtn = document.createElement('button');
                    loginBtn.className = 'account-btn login';
                    loginBtn.textContent = 'Войти';
                    loginBtn.addEventListener('click', () => loginAsUser(username));
                    accountActions.appendChild(loginBtn);
                }
                
                accountItem.appendChild(accountInfo);
                accountItem.appendChild(accountActions);
                accountListElement.appendChild(accountItem);
            });
        }

        // Сохранение профиля
        function saveProfile() {
            console.log("Сохранение профиля...");
            const newUsername = profileUsernameInput.value;
            const newPassword = profilePasswordInput.value;
            const confirmPassword = profileConfirmInput.value;
            
            if (newPassword && newPassword !== confirmPassword) {
                showNotification("Пароли не совпадают!");
                return;
            }
            
            if (newPassword && newPassword.length < 4) {
                showNotification("Пароль должен быть не менее 4 символов!");
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            // Обновляем имя пользователя если оно изменилось
            if (newUsername && newUsername !== currentUser.username) {
                if (users[newUsername]) {
                    showNotification("Пользователь с таким именем уже существует!");
                    return;
                }
                
                // Удаляем старые данные
                delete users[currentUser.username];
                localStorage.removeItem(`userData_${currentUser.username}`);
                
                // Обновляем данные
                currentUser.username = newUsername;
                gameData.profile.username = newUsername;
                users[newUsername] = { password: newPassword || currentUser.password, createdAt: users[currentUser.username]?.createdAt || new Date().toISOString() };
            }
            
            // Обновляем пароль если он изменился
            if (newPassword) {
                users[currentUser.username].password = newPassword;
                currentUser.password = newPassword;
            }
            
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            saveUserData();
            
            updateUserDisplay();
            showNotification("Профиль успешно обновлен!");
            
            // Очищаем поля
            profileUsernameInput.value = '';
            profilePasswordInput.value = '';
            profileConfirmInput.value = '';
            
            // Обновляем список аккаунтов
            updateAccountList();
        }

        // Загрузка данных пользователя
        function loadUserData() {
            console.log("Загрузка данных пользователя...");
            const userData = localStorage.getItem(`userData_${currentUser.username}`);
            if (userData) {
                try {
                    const loadedData = JSON.parse(userData);
                    gameData = loadedData;
                    
                    // Обновляем данные для обратной совместимости
                    if (!gameData.profile) {
                        gameData.profile = {
                            avatar: "😀",
                            username: currentUser.username
                        };
                    }
                    
                    if (!gameData.gameStats) {
                        gameData.gameStats = {
                            "find-emoji": { plays: 0, wins: 0 },
                            "smile-clicker": { plays: 0, score: 0 },
                            "memory": { plays: 0, completes: 0 },
                            "shooting": { plays: 0, hits: 0 },
                            "boss": { plays: 0, wins: 0 }
                        };
                    }
                    
                    if (!gameData.quests) {
                        gameData.quests = {
                            daily: [],
                            progress: {},
                            completed: [],
                            lastUpdate: null
                        };
                    }
                    
                    if (!gameData.dailyBonus) {
                        gameData.dailyBonus = {
                            lastClaim: new Date().toISOString(),
                            streak: 1
                        };
                    }
                    
                    if (!gameData.creator) {
                        gameData.creator = {
                            mouth: "smile",
                            mouthColor: "black",
                            eyes: "big",
                            eyeColor: "black",
                            skin: "white",
                            customColor: "#ffcc00",
                            eyeCustomColor: "#000000",
                            mouthCustomColor: "#000000"
                        };
                    }
                    
                    if (!gameData.ownedEmojis.custom) {
                        gameData.ownedEmojis.custom = [];
                    }
                    
                    // Проверяем ежедневный бонус
                    checkDailyBonus();
                    
                    // Генерируем квесты если нужно
                    if (!gameData.quests.lastUpdate || isNewDay(gameData.quests.lastUpdate)) {
                        generateDailyQuests();
                    }
                    
                } catch (e) {
                    console.error("Ошибка загрузки данных:", e);
                }
            } else {
                // Новый пользователь - начальные монеты
                gameData.coins = 1000;
                gameData.dailyBonus = {
                    lastClaim: new Date().toISOString(),
                    streak: 1
                };
                generateDailyQuests();
                saveUserData();
            }
            
            updateStats();
            renderInventory();
            updateUserDisplay();
            renderAvatarOptions();
            renderQuests();
            updateCustomEmoji();
            updateCreateButton();
        }

        // Проверка ежедневного бонуса
        function checkDailyBonus() {
            const now = new Date();
            const lastClaim = new Date(gameData.dailyBonus.lastClaim);
            
            if (isNewDay(lastClaim)) {
                const daysDiff = Math.floor((now - lastClaim) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 1) {
                    // Последовательные дни
                    gameData.dailyBonus.streak++;
                } else if (daysDiff > 1) {
                    // Пропущенные дни - сброс стрика
                    gameData.dailyBonus.streak = 1;
                }
                
                // Выдаем бонус
                gameData.coins += 1000;
                gameData.dailyBonus.lastClaim = now.toISOString();
                
                showNotification(`🎉 Ежедневный бонус! +1000 монет (стрик: ${gameData.dailyBonus.streak})`);
                updateStats();
                saveUserData();
            }
        }

        // Проверка нового дня
        function isNewDay(date) {
            const last = new Date(date);
            const now = new Date();
            return last.getDate() !== now.getDate() || 
                   last.getMonth() !== now.getMonth() || 
                   last.getFullYear() !== now.getFullYear();
        }

        // Генерация ежедневных квестов
        function generateDailyQuests() {
            // Выбираем 9 случайных квестов
            const shuffled = [...availableQuests].sort(() => 0.5 - Math.random());
            gameData.quests.daily = shuffled.slice(0, 9);
            
            // Добавляем специальные квесты (если еще не выполнены)
            specialQuests.forEach(quest => {
                if (!gameData.quests.completed.includes(quest.id)) {
                    gameData.quests.daily.push(quest);
                }
            });
            
            // Сбрасываем прогресс
            gameData.quests.progress = {};
            gameData.quests.lastUpdate = new Date().toISOString();
            
            // Инициализируем прогресс для новых квестов
            gameData.quests.daily.forEach(quest => {
                if (!gameData.quests.progress[quest.id]) {
                    gameData.quests.progress[quest.id] = 0;
                }
            });
            
            saveUserData();
            renderQuests();
        }

        // Отрисовка квестов
        function renderQuests() {
            questsGrid.innerHTML = '';
            
            gameData.quests.daily.forEach(quest => {
                const progress = gameData.quests.progress[quest.id] || 0;
                const completed = gameData.quests.completed.includes(quest.id);
                const progressPercent = Math.min((progress / quest.target) * 100, 100);
                
                const questCard = document.createElement('div');
                questCard.className = `quest-card ${quest.special ? 'special' : ''} ${completed ? 'quest-completed' : ''}`;
                
                questCard.innerHTML = `
                    <div class="quest-title">${quest.description}</div>
                    <div class="quest-progress">
                        <span>${progress}/${quest.target}</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    <div class="quest-reward">Награда: ${typeof quest.reward === 'number' ? quest.reward + ' монет' : quest.reward}</div>
                `;
                
                // Добавляем обработчик для предпросмотра квеста
                questCard.addEventListener('click', () => {
                    showQuestPreview(quest);
                });
                
                questsGrid.appendChild(questCard);
            });
        }

        // Показать предпросмотр квеста
        function showQuestPreview(quest) {
            questPreviewTitle.textContent = quest.description;
            questPreviewDescription.textContent = `Прогресс: ${gameData.quests.progress[quest.id] || 0}/${quest.target}`;
            questPreviewReward.textContent = `Награда: ${typeof quest.reward === 'number' ? quest.reward + ' монет' : quest.reward}`;
            
            // Устанавливаем эмодзи для предпросмотра
            if (quest.reward === animatedBear) {
                questPreviewEmoji.innerHTML = `
                    <div class="animated-bear">
                        <div class="bear-ear left"></div>
                        <div class="bear-ear right"></div>
                    </div>
                `;
            } else if (quest.reward === animatedPumpkin) {
                questPreviewEmoji.innerHTML = `
                    <div class="animated-pumpkin">
                        <div class="pumpkin-stem"></div>
                    </div>
                `;
            } else if (typeof quest.reward === 'number') {
                questPreviewEmoji.textContent = '💰';
            } else {
                questPreviewEmoji.textContent = quest.reward;
            }
            
            questPreviewModal.style.display = 'block';
        }

        // Обновление прогресса квеста
        function updateQuestProgress(questId, amount = 1) {
            if (!gameData.quests.progress[questId]) {
                gameData.quests.progress[questId] = 0;
            }
            
            gameData.quests.progress[questId] += amount;
            
            const quest = gameData.quests.daily.find(q => q.id === questId);
            if (quest && gameData.quests.progress[questId] >= quest.target && !gameData.quests.completed.includes(questId)) {
                completeQuest(quest);
            }
            
            renderQuests();
            saveUserData();
        }

        // Завершение квеста
        function completeQuest(quest) {
            gameData.quests.completed.push(quest.id);
            
            if (typeof quest.reward === 'number') {
                gameData.coins += quest.reward;
                showNotification(`🎉 Квест выполнен! +${quest.reward} монет`);
            } else {
                // Специальная награда (анимированный смайл)
                if (!gameData.ownedEmojis.unique.includes(quest.reward)) {
                    gameData.ownedEmojis.unique.push(quest.reward);
                    showNotification(`🎉 Особый квест выполнен! Получен: ${quest.reward}`);
                    renderInventory();
                }
            }
            
            updateStats();
            saveUserData();
        }

        // Обновление отображения пользователя
        function updateUserDisplay() {
            usernameDisplayElement.textContent = gameData.profile.username || currentUser.username;
            
            // Проверяем, является ли аватар анимированным смайлом
            if (gameData.profile.avatar === animatedBear) {
                userAvatarElement.innerHTML = `
                    <div class="animated-bear">
                        <div class="bear-ear left"></div>
                        <div class="bear-ear right"></div>
                    </div>
                `;
            } else if (gameData.profile.avatar === animatedPumpkin) {
                userAvatarElement.innerHTML = `
                    <div class="animated-pumpkin">
                        <div class="pumpkin-stem"></div>
                    </div>
                `;
            } else if (gameData.profile.avatar.startsWith('custom-')) {
                // Отображаем кастомный смайл
                const customData = gameData.customEmojis[gameData.profile.avatar];
                if (customData) {
                    userAvatarElement.innerHTML = `
                        <div class="custom-emoji" style="width: 40px; height: 40px;">
                            <div class="emoji-face">
                                <div class="emoji-eyes">
                                    <div class="eye" style="width: 8px; height: 8px;"></div>
                                    <div class="eye" style="width: 8px; height: 8px;"></div>
                                </div>
                                <div class="emoji-mouth" style="width: 20px; height: 5px; bottom: 10px;"></div>
                            </div>
                        </div>
                    `;
                    
                    // Применяем настройки кастомного смайла
                    const customEmoji = userAvatarElement.querySelector('.custom-emoji');
                    switch(customData.skin) {
                        case 'white':
                            customEmoji.style.background = '#ffdbac';
                            break;
                        case 'black':
                            customEmoji.style.background = '#8d5524';
                            break;
                        case 'rainbow':
                            customEmoji.style.background = 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)';
                            break;
                        case 'shiny':
                            customEmoji.style.background = 'linear-gradient(135deg, #ffcc00, #ff9900, #ffcc00)';
                            break;
                        case 'custom':
                            customEmoji.style.background = customData.customColor;
                            break;
                    }
                }
            } else {
                userAvatarElement.textContent = gameData.profile.avatar || "😀";
            }
        }

        // Сохранение данных пользователя
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem(`userData_${currentUser.username}`, JSON.stringify(gameData));
            }
        }

        // Показать игровой интерфейс
        function showGame() {
            authContainer.style.display = 'none';
            gameContainer.style.display = 'block';
            updateUserDisplay();
        }

        // Настройка вкладок
        function setupTabs() {
            console.log("Настройка вкладок...");
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    
                    // Убираем активный класс у всех вкладок и контента
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(tc => tc.classList.remove('active'));
                    
                    // Добавляем активный класс к выбранной вкладке и контенту
                    tab.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // Показываем выбор игр при переходе на вкладку игр
                    if (tabId === 'games') {
                        showGameSelection();
                    }
                    
                    // Обновляем кнопку создания при переходе на вкладку креатора
                    if (tabId === 'creator') {
                        updateCreateButton();
                    }
                });
            });
        }

        // Показать выбор игр
        function showGameSelection() {
            document.querySelector('.game-selection').style.display = 'grid';
            document.getElementById('find-emoji-game').style.display = 'none';
            document.getElementById('smile-clicker-game').style.display = 'none';
            document.getElementById('memory-game').style.display = 'none';
            document.getElementById('shooting-game').style.display = 'none';
            document.getElementById('boss-game').style.display = 'none';
            
            // Останавливаем музыку босса и включаем основную
            if (bossMusic) {
                bossMusic.pause();
                bossMusic.currentTime = 0;
            }
            if (musicEnabled && backgroundMusic) {
                backgroundMusic.play().catch(e => console.log("Воспроизведение заблокировано:", e));
            }
        }

        // Запуск игры
        function startGame(gameType) {
            showGameSelection(); // Сначала скрываем все
            
            switch(gameType) {
                case 'find-emoji':
                    startFindEmojiGame();
                    break;
                case 'smile-clicker':
                    startClickerGame();
                    break;
                case 'memory':
                    startMemoryGame();
                    break;
                case 'shooting':
                    startShootingGame();
                    break;
                case 'boss':
                    startBossGame();
                    break;
            }
        }

        // Обновление статистики
        function updateStats() {
            coinsElement.textContent = gameData.coins;
            boxesOpenedElement.textContent = gameData.boxesOpened;
            
            // Подсчет уникальных смайлов
            let uniqueCount = 0;
            for (const category in gameData.ownedEmojis) {
                uniqueCount += gameData.ownedEmojis[category].length;
            }
            uniqueEmojisElement.textContent = uniqueCount;
            
            // Обновляем состояние кнопки открытия бокса
            openButton.disabled = gameData.coins < 10;
            
            // Обновляем кнопку создания смайла
            updateCreateButton();
            
            saveUserData();
        }

        // Открытие бокса
        function openBox() {
            if (gameData.coins < 10) {
                showNotification("Недостаточно монет!");
                return;
            }
            
            console.log("Открытие бокса...");
            // Сброс анимации
            boxElement.classList.remove('open');
            boxGlowElement.style.opacity = 0;
            resultElement.textContent = '';
            openButton.disabled = true;
            
            // Очистка искр
            boxSparklesElement.innerHTML = '';
            
            // Создание искр
            createSparkles();
            
            // Анимация вращения
            boxElement.style.transform = 'rotateY(0deg)';
            setTimeout(() => {
                boxElement.style.transform = 'rotateY(720deg)';
            }, 10);
            
            // Открытие бокса после задержки
            setTimeout(() => {
                boxElement.classList.add('open');
                boxGlowElement.style.opacity = 1;
                
                // Выпадение награды после открытия
                setTimeout(() => {
                    const reward = getRandomReward();
                    displayReward(reward);
                    gameData.coins -= 10;
                    gameData.boxesOpened++;
                    
                    // Обновляем квесты
                    updateQuestProgress("open10");
                    updateQuestProgress("bear150");
                    updateQuestProgress("pumpkin200");
                    
                    // Обновляем квесты по категориям смайлов
                    if (reward.category && reward.category !== 'disappear' && reward.category !== 'unique') {
                        updateQuestProgress(`${reward.category}5`);
                    }
                    
                    // Квест на уникальные смайлы
                    if (reward.category === 'unique' && reward.isNew) {
                        updateQuestProgress("unique1");
                    }
                    
                    updateStats();
                    openButton.disabled = gameData.coins < 10;
                }, 1000);
            }, 500);
        }

        // Создание искр
        function createSparkles() {
            for (let i = 0; i < 30; i++) {
                const sparkle = document.createElement('div');
                sparkle.className = 'sparkle';
                sparkle.style.left = `${Math.random() * 100}%`;
                sparkle.style.top = `${Math.random() * 100}%`;
                sparkle.style.animationDelay = `${Math.random() * 0.5}s`;
                boxSparklesElement.appendChild(sparkle);
            }
        }

        // Получение случайной награды
        function getRandomReward() {
            const random = Math.random() * 100;
            let cumulativeRate = 0;
            
            for (const category in dropRates) {
                cumulativeRate += dropRates[category];
                if (random <= cumulativeRate) {
                    if (category === 'disappear') {
                        return {
                            category: 'disappear',
                            emoji: '💥',
                            isNew: false
                        };
                    }
                    
                    // Получаем доступные смайлы в категории (те, которых еще нет у игрока)
                    const availableEmojis = emojiDatabase[category].filter(
                        emoji => !gameData.ownedEmojis[category].includes(emoji)
                    );
                    
                    // Если все смайлы уже получены, возвращаем случайный из категории
                    if (availableEmojis.length === 0) {
                        const randomIndex = Math.floor(Math.random() * emojiDatabase[category].length);
                        return {
                            category: category,
                            emoji: emojiDatabase[category][randomIndex],
                            isNew: false
                        };
                    }
                    
                    // Возвращаем случайный смайл из доступных
                    const randomIndex = Math.floor(Math.random() * availableEmojis.length);
                    return {
                        category: category,
                        emoji: availableEmojis[randomIndex],
                        isNew: true
                    };
                }
            }
            
            // На всякий случай возвращаем смайл лица
            return {
                category: 'faces',
                emoji: '😀',
                isNew: false
            };
        }

        // Отображение награды
        function displayReward(reward) {
            if (reward.category === 'disappear') {
                // Эффект исчезновения всех смайлов
                showNotification("💥 ВСЕ СМАЙЛЫ ИСЧЕЗЛИ! 💥");
                createDisappearEffect();
                
                // Очищаем коллекцию
                for (const category in gameData.ownedEmojis) {
                    gameData.ownedEmojis[category] = [];
                }
                
                renderInventory();
                resultElement.textContent = '💥';
            } else {
                resultElement.textContent = reward.emoji;
                
                // Если это новый смайл, добавляем в коллекцию
                if (reward.isNew) {
                    gameData.ownedEmojis[reward.category].push(reward.emoji);
                    showNotification(`🎉 Получен новый смайл: ${reward.emoji} 🎉`);
                    renderInventory();
                } else {
                    showNotification("Смайл уже был в коллекции!");
                }
            }
            
            updateStats();
        }

        // Создание эффекта исчезновения
        function createDisappearEffect() {
            const effect = document.createElement('div');
            effect.className = 'disappear-effect';
            effect.textContent = '💥';
            document.body.appendChild(effect);
            
            setTimeout(() => {
                document.body.removeChild(effect);
            }, 3000);
        }

        // Игра "Найди смайлик"
        function startFindEmojiGame() {
            console.log("Начало игры 'Найди смайлик'");
            
            document.querySelector('.game-selection').style.display = 'none';
            document.getElementById('find-emoji-game').style.display = 'block';
            
            gameActive = true;
            currentLevel = 1;
            gameTimeLeft = getTimeForLevel(currentLevel);
            gameResultElement.textContent = '';
            
            // Подготавливаем пары для всех уровней
            currentRoundPairs = [
                findEmojiPairs.easy[Math.floor(Math.random() * findEmojiPairs.easy.length)],
                findEmojiPairs.medium[Math.floor(Math.random() * findEmojiPairs.medium.length)],
                findEmojiPairs.hard[Math.floor(Math.random() * findEmojiPairs.hard.length)]
            ];
            
            // Начинаем с первого уровня
            startLevel(1);
            
            // Обновляем статистику игр
            gameData.gameStats["find-emoji"].plays++;
            updateQuestProgress("find5");
            updateQuestProgress("find10");
            updateQuestProgress("find12");
            saveUserData();
        }

        // Начало уровня
        function startLevel(level) {
            currentLevel = level;
            currentLevelElement.textContent = level;
            gameTimeLeft = getTimeForLevel(level);
            gameTimerElement.textContent = gameTimeLeft;
            
            // Выбираем пару для текущего уровня
            currentGamePair = currentRoundPairs[level - 1];
            targetEmojiElement.textContent = currentGamePair.target;
            
            // Генерируем сетку с учетом уровня сложности
            generateEmojiGrid(level);
            
            // Запускаем таймер
            if (gameTimer) clearInterval(gameTimer);
            gameTimer = setInterval(updateGameTimer, 1000);
        }

        // Получение времени для уровня
        function getTimeForLevel(level) {
            switch(level) {
                case 1: return 15;
                case 2: return 12;
                case 3: return 10;
                default: return 10;
            }
        }

        // Обновление таймера игры
        function updateGameTimer() {
            gameTimeLeft--;
            gameTimerElement.textContent = gameTimeLeft;
            
            if (gameTimeLeft <= 0) {
                endFindEmojiGame(false);
            }
        }

        // Генерация сетки эмодзи с учетом уровня сложности
        function generateEmojiGrid(level) {
            emojiGridElement.innerHTML = '';
            
            // Размер сетки зависит от уровня
            const gridSize = level === 1 ? 6 : level === 2 ? 8 : 10;
            const totalCells = gridSize * gridSize;
            
            emojiGridElement.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
            
            const targetPosition = Math.floor(Math.random() * totalCells);
            
            for (let i = 0; i < totalCells; i++) {
                const cell = document.createElement('div');
                cell.className = 'emoji-cell';
                
                // Размер шрифта зависит от уровня
                cell.style.fontSize = level === 1 ? '28px' : level === 2 ? '24px' : '20px';
                
                if (i === targetPosition) {
                    cell.textContent = currentGamePair.target;
                    cell.dataset.correct = true;
                } else {
                    cell.textContent = currentGamePair.common;
                }
                
                cell.addEventListener('click', handleEmojiClick);
                emojiGridElement.appendChild(cell);
            }
        }

        // Обработка клика по эмодзи
        function handleEmojiClick(event) {
            if (!gameActive) return;
            
            const cell = event.target;
            
            if (cell.dataset.correct) {
                cell.classList.add('correct');
                
                // Переход на следующий уровень или завершение игры
                if (currentLevel < 3) {
                    setTimeout(() => {
                        startLevel(currentLevel + 1);
                    }, 1000);
                } else {
                    endFindEmojiGame(true);
                }
            } else {
                cell.classList.add('wrong');
                setTimeout(() => {
                    cell.classList.remove('wrong');
                }, 500);
                
                // Штраф -3 секунды
                gameTimeLeft = Math.max(0, gameTimeLeft - 3);
                gameTimerElement.textContent = gameTimeLeft;
                
                if (gameTimeLeft <= 0) {
                    endFindEmojiGame(false);
                }
            }
        }

        // Завершение игры
        function endFindEmojiGame(isWin) {
            gameActive = false;
            clearInterval(gameTimer);
            
            if (isWin && currentLevel === 3) {
                gameResultElement.textContent = "🎉 Поздравляем! Вы прошли все 3 уровня! +100 монет";
                gameData.coins += 100;
                gameData.gameStats["find-emoji"].wins++;
                updateStats();
                showNotification("+100 монет за прохождение игры!");
            } else if (isWin) {
                // Не должно происходить, но на всякий случай
                gameResultElement.textContent = "Уровень пройден!";
            } else {
                gameResultElement.textContent = `💤 Игра окончена! Вы дошли до уровня ${currentLevel}.`;
            }
            
            saveUserData();
        }

        // Игра "Смайл Кликер"
        function startClickerGame() {
            console.log("Начало игры 'Смайл Кликер'");
            
            document.querySelector('.game-selection').style.display = 'none';
            document.getElementById('smile-clicker-game').style.display = 'block';
            
            clickerScore = 0;
            gameTimeLeft = 30;
            document.getElementById('clicker-score').textContent = '0';
            document.getElementById('clicker-timer').textContent = '30';
            document.getElementById('clicker-result').textContent = '';
            
            // Очищаем область кликера
            const clickerArea = document.getElementById('clicker-area');
            clickerArea.innerHTML = '';
            clickerEmojis = [];
            
            // Запускаем таймер
            if (gameTimer) clearInterval(gameTimer);
            gameTimer = setInterval(updateClickerTimer, 1000);
            
            // Создаем первый смайлик
            createClickerEmoji();
            
            // Обновляем статистику игр
            gameData.gameStats["smile-clicker"].plays++;
            updateQuestProgress("clicker5");
            updateQuestProgress("clicker10");
            updateQuestProgress("clicker12");
            saveUserData();
        }

        // Обновление таймера кликера
        function updateClickerTimer() {
            gameTimeLeft--;
            document.getElementById('clicker-timer').textContent = gameTimeLeft;
            
            if (gameTimeLeft <= 0) {
                endClickerGame();
            }
            
            // Создаем новые смайлики каждые 0.5-2 секунды
            if (Math.random() < 0.3) {
                createClickerEmoji();
            }
        }

        // Создание смайлика для кликера
        function createClickerEmoji() {
            const clickerArea = document.getElementById('clicker-area');
            const emoji = document.createElement('div');
            emoji.className = 'clicker-emoji';
            
            // Случайный смайлик
            const categories = Object.values(emojiDatabase);
            const randomCategory = categories[Math.floor(Math.random() * categories.length)];
            const randomEmoji = randomCategory[Math.floor(Math.random() * randomCategory.length)];
            
            emoji.textContent = randomEmoji;
            
            // Случайная позиция
            const x = Math.random() * (clickerArea.offsetWidth - 50);
            const y = Math.random() * (clickerArea.offsetHeight - 50);
            
            emoji.style.left = x + 'px';
            emoji.style.top = y + 'px';
            
            // Обработчик клика
            emoji.addEventListener('click', () => {
                clickerScore++;
                document.getElementById('clicker-score').textContent = clickerScore;
                emoji.remove();
                
                // Начисляем монеты за каждый собранный смайл
                gameData.coins += 10;
                updateStats();
                
                // Создаем анимацию очков
                const scoreAnim = document.createElement('div');
                scoreAnim.textContent = '+10 монет';
                scoreAnim.style.position = 'absolute';
                scoreAnim.style.left = x + 'px';
                scoreAnim.style.top = y + 'px';
                scoreAnim.style.color = '#4a90e2';
                scoreAnim.style.fontWeight = 'bold';
                scoreAnim.style.fontSize = '16px';
                scoreAnim.style.pointerEvents = 'none';
                scoreAnim.style.animation = 'coins-float 1s ease-out forwards';
                clickerArea.appendChild(scoreAnim);
                
                setTimeout(() => {
                    scoreAnim.remove();
                }, 1000);
            });
            
            clickerArea.appendChild(emoji);
            clickerEmojis.push(emoji);
            
            // Удаляем смайлик через 3 секунды
            setTimeout(() => {
                if (emoji.parentNode) {
                    emoji.remove();
                }
            }, 3000);
        }

        // Завершение игры кликера
        function endClickerGame() {
            clearInterval(gameTimer);
            
            gameData.gameStats["smile-clicker"].score = Math.max(gameData.gameStats["smile-clicker"].score, clickerScore);
            
            document.getElementById('clicker-result').textContent = 
                `🎯 Игра окончена! Очки: ${clickerScore} | Собрано монет: ${clickerScore * 10}`;
            
            showNotification(`+${clickerScore * 10} монет за игру в кликер!`);
            saveUserData();
        }

        // Игра "Найди пару"
        function startMemoryGame() {
            console.log("Начало игры 'Найди пару'");
            
            document.querySelector('.game-selection').style.display = 'none';
            document.getElementById('memory-game').style.display = 'block';
            memoryCompleteElement.style.display = 'none';
            
            matchedPairs = 0;
            selectedCards = [];
            pairsFoundElement.textContent = '0';
            
            generateMemoryGrid();
            
            // Обновляем статистику игр
            gameData.gameStats["memory"].plays++;
            updateQuestProgress("memory3");
            updateQuestProgress("memory6");
            updateQuestProgress("memory8");
            saveUserData();
        }

        // Генерация сетки для игры "Найди пару"
        function generateMemoryGrid() {
            memoryGrid.innerHTML = '';
            
            // Создаем 15 пар смайлов (30 карточек)
            const emojis = [];
            const allEmojis = Object.values(emojiDatabase).flat();
            
            // Выбираем 15 случайных смайлов
            for (let i = 0; i < totalPairs; i++) {
                let randomEmoji;
                do {
                    randomEmoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
                } while (emojis.includes(randomEmoji));
                
                emojis.push(randomEmoji);
            }
            
            // Создаем пары
            memoryCards = [];
            emojis.forEach(emoji => {
                memoryCards.push({ emoji, matched: false });
                memoryCards.push({ emoji, matched: false });
            });
            
            // Перемешиваем карточки
            for (let i = memoryCards.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [memoryCards[i], memoryCards[j]] = [memoryCards[j], memoryCards[i]];
            }
            
            // Создаем элементы карточек
            memoryCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                cardElement.className = 'memory-cell';
                cardElement.textContent = '?';
                cardElement.dataset.index = index;
                
                cardElement.addEventListener('click', handleMemoryCardClick);
                memoryGrid.appendChild(cardElement);
            });
        }

        // Обработка клика по карточке
        function handleMemoryCardClick(event) {
            const cardElement = event.target;
            const index = parseInt(cardElement.dataset.index);
            
            // Если карточка уже выбрана или совпала, игнорируем клик
            if (selectedCards.includes(index) || memoryCards[index].matched) {
                return;
            }
            
            // Показываем смайлик
            cardElement.textContent = memoryCards[index].emoji;
            cardElement.classList.add('selected');
            
            // Добавляем карточку в выбранные
            selectedCards.push(index);
            
            // Если выбрано 2 карточки, проверяем совпадение
            if (selectedCards.length === 2) {
                const [firstIndex, secondIndex] = selectedCards;
                
                if (memoryCards[firstIndex].emoji === memoryCards[secondIndex].emoji) {
                    // Совпадение!
                    memoryCards[firstIndex].matched = true;
                    memoryCards[secondIndex].matched = true;
                    
                    setTimeout(() => {
                        document.querySelector(`[data-index="${firstIndex}"]`).classList.add('matched');
                        document.querySelector(`[data-index="${secondIndex}"]`).classList.add('matched');
                        
                        selectedCards = [];
                        matchedPairs++;
                        pairsFoundElement.textContent = matchedPairs;
                        
                        // Проверяем завершение игры
                        if (matchedPairs === totalPairs) {
                            endMemoryGame();
                        }
                    }, 500);
                } else {
                    // Не совпало, скрываем карточки через секунду
                    setTimeout(() => {
                        document.querySelector(`[data-index="${firstIndex}"]`).textContent = '?';
                        document.querySelector(`[data-index="${secondIndex}"]`).textContent = '?';
                        document.querySelector(`[data-index="${firstIndex}"]`).classList.remove('selected');
                        document.querySelector(`[data-index="${secondIndex}"]`).classList.remove('selected');
                        
                        selectedCards = [];
                    }, 1000);
                }
            }
        }

        // Завершение игры "Найди пару"
        function endMemoryGame() {
            memoryCompleteElement.style.display = 'block';
            
            const reward = 400;
            gameData.coins += reward;
            gameData.gameStats["memory"].completes++;
            
            updateStats();
            showNotification(`+${reward} монет за нахождение всех пар!`);
            saveUserData();
        }

        // Игра "Тир"
        function startShootingGame() {
            console.log("Начало игры 'Тир'");
            
            document.querySelector('.game-selection').style.display = 'none';
            document.getElementById('shooting-game').style.display = 'block';
            
            hitsCount = 0;
            targets = [];
            bullets = [];
            hitsCountElement.textContent = '0';
            shootingResult.textContent = '';
            
            // Очищаем тир
            shootingRange.innerHTML = '';
            
            // Создаем мишени
            createTargets();
            
            // Обработчик клика для стрельбы
            shootingRange.addEventListener('click', handleShootingClick);
            
            // Обновляем статистику игр
            gameData.gameStats["shooting"].plays++;
            updateQuestProgress("shooting5");
            updateQuestProgress("shooting10");
            updateQuestProgress("shooting12");
            saveUserData();
        }

        // Создание мишеней
        function createTargets() {
            for (let i = 0; i < 10; i++) { // Теперь 10 мишеней
                createTarget();
            }
        }

        // Создание одной мишени
        function createTarget() {
            const target = document.createElement('div');
            target.className = 'target';
            
            // Случайный смайлик
            const allEmojis = Object.values(emojiDatabase).flat();
            const randomEmoji = allEmojis[Math.floor(Math.random() * allEmojis.length)];
            target.textContent = randomEmoji;
            
            // Случайная позиция
            const x = Math.random() * (shootingRange.offsetWidth - 50);
            const y = Math.random() * (shootingRange.offsetHeight - 100) + 50;
            
            target.style.left = x + 'px';
            target.style.top = y + 'px';
            
            // Добавляем мишень в тир
            shootingRange.appendChild(target);
            targets.push({
                element: target,
                x: x,
                y: y,
                hit: false
            });
        }

        // Обработка клика для стрельбы
        function handleShootingClick(event) {
            const rect = shootingRange.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const clickY = event.clientY - rect.top;
            
            // Создаем пулю
            createBullet(clickX, clickY);
            
            // Проверяем попадание
            checkHit(clickX, clickY);
        }

        // Создание пули
        function createBullet(x, y) {
            const bullet = document.createElement('div');
            bullet.className = 'bullet';
            bullet.textContent = '💥';
            bullet.style.left = x + 'px';
            bullet.style.top = y + 'px';
            
            shootingRange.appendChild(bullet);
            bullets.push(bullet);
            
            // Удаляем пулю через 500 мс
            setTimeout(() => {
                if (bullet.parentNode) {
                    bullet.remove();
                }
            }, 500);
        }

        // Проверка попадания
        function checkHit(x, y) {
            for (let i = 0; i < targets.length; i++) {
                const target = targets[i];
                if (!target.hit) {
                    const targetRect = target.element.getBoundingClientRect();
                    const rangeRect = shootingRange.getBoundingClientRect();
                    
                    const targetX = targetRect.left - rangeRect.left + targetRect.width / 2;
                    const targetY = targetRect.top - rangeRect.top + targetRect.height / 2;
                    
                    const distance = Math.sqrt(Math.pow(x - targetX, 2) + Math.pow(y - targetY, 2));
                    
                    if (distance < 30) { // Попадание
                        target.hit = true;
                        target.element.style.opacity = '0.5';
                        hitsCount++;
                        hitsCountElement.textContent = hitsCount;
                        
                        // Удаляем мишень через 500 мс
                        setTimeout(() => {
                            if (target.element.parentNode) {
                                target.element.remove();
                            }
                        }, 500);
                        
                        // Создаем новую мишень
                        setTimeout(() => {
                            createTarget();
                        }, 1000);
                        
                        // Проверяем завершение игры
                        if (hitsCount >= 10) { // Теперь нужно 10 попаданий
                            endShootingGame();
                        }
                        
                        break;
                    }
                }
            }
        }

        // Завершение игры "Тир"
        function endShootingGame() {
            // Убираем обработчик клика
            shootingRange.removeEventListener('click', handleShootingClick);
            
            const reward = 100;
            gameData.coins += reward;
            gameData.gameStats["shooting"].hits += hitsCount;
            
            shootingResult.textContent = `🎯 Отличная стрельба! +${reward} монет`;
            updateStats();
            showNotification(`+${reward} монет за попадание в 10 мишеней!`);
            saveUserData();
        }

        // Игра "Против босса"
        function startBossGame() {
            console.log("Начало игры 'Против босса'");
            
            document.querySelector('.game-selection').style.display = 'none';
            document.getElementById('boss-game').style.display = 'block';
            
            // Останавливаем основную музыку и включаем музыку босса
            if (backgroundMusic) {
                backgroundMusic.pause();
            }
            if (musicEnabled && bossMusic) {
                bossMusic.play().catch(e => console.log("Воспроизведение заблокировано:", e));
            }
            
            bossTimeLeft = 60;
            playerPosition = { x: 300, y: 350 };
            projectiles = [];
            bossTimerElement.textContent = '60';
            bossResult.textContent = '';
            lastProjectileTime = 0;
            
            // Очищаем арену
            bossArena.innerHTML = '';
            
            // Создаем босса и игрока
            const boss = document.createElement('div');
            boss.className = 'boss';
            boss.textContent = '👹';
            bossArena.appendChild(boss);
            
            const player = document.createElement('div');
            player.className = 'player';
            player.textContent = '😎';
            player.style.left = playerPosition.x + 'px';
            player.style.top = playerPosition.y + 'px';
            bossArena.appendChild(player);
            
            // Запускаем игровой цикл
            gameInterval = setInterval(updateBossGame, 50);
            
            // Запускаем таймер
            gameTimer = setInterval(updateBossTimer, 1000);
            
            // Обработчики клавиш
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
            
            // Обновляем статистику игр
            gameData.gameStats["boss"].plays++;
            updateQuestProgress("boss3");
            updateQuestProgress("boss6");
            updateQuestProgress("boss8");
            saveUserData();
        }

        // Обработка нажатия клавиш
        function handleKeyDown(event) {
            keys[event.key] = true;
        }

        // Обработка отпускания клавиш
        function handleKeyUp(event) {
            keys[event.key] = false;
        }

        // Обновление таймера босса
        function updateBossTimer() {
            bossTimeLeft--;
            bossTimerElement.textContent = bossTimeLeft;
            
            if (bossTimeLeft <= 0) {
                endBossGame(true);
            }
        }

        // Обновление игры с боссом
        function updateBossGame() {
            // Движение игрока с учетом джойстика
            let moveX = 0;
            let moveY = 0;
            
            // Управление с клавиатуры
            if (keys['w'] || keys['W'] || keys['ArrowUp']) {
                moveY -= 5;
            }
            if (keys['s'] || keys['S'] || keys['ArrowDown']) {
                moveY += 5;
            }
            if (keys['a'] || keys['A'] || keys['ArrowLeft']) {
                moveX -= 5;
            }
            if (keys['d'] || keys['D'] || keys['ArrowRight']) {
                moveX += 5;
            }
            
            // Управление с джойстика
            if (joystickActive) {
                moveX += joystickDirection.x * 5;
                moveY += joystickDirection.y * 5;
            }
            
            // Обновляем позицию игрока с ограничениями
            playerPosition.x = Math.max(50, Math.min(550, playerPosition.x + moveX));
            playerPosition.y = Math.max(50, Math.min(350, playerPosition.y + moveY));
            
            // Обновляем позицию игрока
            const player = bossArena.querySelector('.player');
            player.style.left = playerPosition.x + 'px';
            player.style.top = playerPosition.y + 'px';
            
            // Создаем снаряды с интервалом
            const currentTime = Date.now();
            if (currentTime - lastProjectileTime > PROJECTILE_INTERVAL) {
                createProjectile();
                lastProjectileTime = currentTime;
            }
            
            // Обновляем снаряды
            updateProjectiles();
            
            // Проверяем столкновения
            checkCollisions();
        }

        // Создание снаряда
        function createProjectile() {
            const types = ['rock', 'emoji']; // Убрали лазеры
            const type = types[Math.floor(Math.random() * types.length)];
            
            let projectile;
            
            switch(type) {
                case 'rock':
                    projectile = document.createElement('div');
                    projectile.className = 'rock';
                    projectile.style.left = (Math.random() * 500 + 50) + 'px';
                    projectile.style.top = '50px';
                    break;
                    
                case 'emoji':
                    projectile = document.createElement('div');
                    projectile.className = 'projectile';
                    projectile.textContent = '💥';
                    projectile.style.left = (Math.random() * 500 + 50) + 'px';
                    projectile.style.top = '50px';
                    break;
            }
            
            if (projectile) {
                bossArena.appendChild(projectile);
                projectiles.push({
                    element: projectile,
                    type: type,
                    x: parseInt(projectile.style.left),
                    y: parseInt(projectile.style.top),
                    speed: 3
                });
            }
        }

        // Обновление снарядов
        function updateProjectiles() {
            for (let i = projectiles.length - 1; i >= 0; i--) {
                const projectile = projectiles[i];
                
                // Движение снаряда вниз
                projectile.y += projectile.speed;
                projectile.element.style.top = projectile.y + 'px';
                
                // Удаляем снаряды, вышедшие за пределы арены
                if (projectile.y > 400) {
                    projectile.element.remove();
                    projectiles.splice(i, 1);
                }
            }
        }

        // Проверка столкновений
        function checkCollisions() {
            const playerRect = {
                x: playerPosition.x - 20,
                y: playerPosition.y - 20,
                width: 40,
                height: 40
            };
            
            for (let i = 0; i < projectiles.length; i++) {
                const projectile = projectiles[i];
                let projectileRect;
                
                if (projectile.type === 'rock') {
                    projectileRect = {
                        x: projectile.x - 15,
                        y: projectile.y - 15,
                        width: 30,
                        height: 30
                    };
                } else {
                    projectileRect = {
                        x: projectile.x - 15,
                        y: projectile.y - 15,
                        width: 30,
                        height: 30
                    };
                }
                
                // Проверка столкновения
                if (playerRect.x < projectileRect.x + projectileRect.width &&
                    playerRect.x + playerRect.width > projectileRect.x &&
                    playerRect.y < projectileRect.y + projectileRect.height &&
                    playerRect.y + playerRect.height > projectileRect.y) {
                    
                    // Столкновение!
                    endBossGame(false);
                    break;
                }
            }
        }

        // Завершение игры с боссом
        function endBossGame(isWin) {
            // Останавливаем игровой цикл и таймер
            clearInterval(gameInterval);
            clearInterval(gameTimer);
            
            // Убираем обработчики клавиш
            document.removeEventListener('keydown', handleKeyDown);
            document.removeEventListener('keyup', handleKeyUp);
            
            // Останавливаем музыку босса и включаем основную
            if (bossMusic) {
                bossMusic.pause();
                bossMusic.currentTime = 0;
            }
            if (musicEnabled && backgroundMusic) {
                backgroundMusic.play().catch(e => console.log("Воспроизведение заблокировано:", e));
            }
            
            if (isWin) {
                const reward = 400;
                gameData.coins += reward;
                gameData.gameStats["boss"].wins++;
                
                bossResult.textContent = `🎉 Победа! Вы продержались 60 секунд! +${reward} монет`;
                updateStats();
                showNotification(`+${reward} монет за победу над боссом!`);
            } else {
                bossResult.textContent = `💥 Поражение! Вы продержались ${60 - bossTimeLeft} секунд.`;
            }
            
            saveUserData();
        }

        // Отрисовка опций аватара
        function renderAvatarOptions() {
            avatarOptionsElement.innerHTML = '';
            
            // Собираем все доступные смайлы
            const availableEmojis = [];
            
            // Добавляем обычные смайлы
            for (const category in gameData.ownedEmojis) {
                if (category === 'custom') {
                    // Добавляем кастомные смайлы
                    gameData.ownedEmojis[category].forEach(id => {
                        availableEmojis.push(id);
                    });
                } else {
                    availableEmojis.push(...gameData.ownedEmojis[category]);
                }
            }
            
            // Убираем дубликаты
            const uniqueEmojis = [...new Set(availableEmojis)];
            
            // Сортируем для удобства
            uniqueEmojis.sort();
            
            // Создаем элементы выбора
            uniqueEmojis.forEach(emoji => {
                const avatarOption = document.createElement('div');
                
                // Проверяем, является ли это анимированным медведем
                if (emoji === animatedBear) {
                    avatarOption.className = `animated-bear ${emoji === gameData.profile.avatar ? 'selected' : ''}`;
                    avatarOption.innerHTML = `
                        <div class="bear-ear left"></div>
                        <div class="bear-ear right"></div>
                    `;
                } 
                // Проверяем, является ли это анимированной тыквой
                else if (emoji === animatedPumpkin) {
                    avatarOption.className = `animated-pumpkin ${emoji === gameData.profile.avatar ? 'selected' : ''}`;
                    avatarOption.innerHTML = `
                        <div class="pumpkin-stem"></div>
                    `;
                }
                // Проверяем, является ли это кастомным смайлом
                else if (emoji.startsWith('custom-')) {
                    const customData = gameData.customEmojis[emoji];
                    if (customData) {
                        avatarOption.className = `custom-emoji ${emoji === gameData.profile.avatar ? 'selected' : ''}`;
                        avatarOption.style.width = '50px';
                        avatarOption.style.height = '50px';
                        avatarOption.innerHTML = `
                            <div class="emoji-face">
                                <div class="emoji-eyes">
                                    <div class="eye" style="width: 8px; height: 8px;"></div>
                                    <div class="eye" style="width: 8px; height: 8px;"></div>
                                </div>
                                <div class="emoji-mouth" style="width: 20px; height: 5px; bottom: 12px;"></div>
                            </div>
                        `;
                        
                        // Применяем настройки кастомного смайла
                        switch(customData.skin) {
                            case 'white':
                                avatarOption.style.background = '#ffdbac';
                                break;
                            case 'black':
                                avatarOption.style.background = '#8d5524';
                                break;
                            case 'rainbow':
                                avatarOption.style.background = 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)';
                                break;
                            case 'shiny':
                                avatarOption.style.background = 'linear-gradient(135deg, #ffcc00, #ff9900, #ffcc00)';
                                break;
                            case 'custom':
                                avatarOption.style.background = customData.customColor;
                                break;
                        }
                    }
                }
                else {
                    avatarOption.className = `emoji-item owned ${emoji === gameData.profile.avatar ? 'selected' : ''}`;
                    avatarOption.textContent = emoji;
                }
                
                avatarOption.title = "Выбрать аватар";
                avatarOption.addEventListener('click', () => selectAvatar(emoji));
                avatarOptionsElement.appendChild(avatarOption);
            });
            
            // Если нет доступных смайлов
            if (uniqueEmojis.length === 0) {
                const noAvatars = document.createElement('div');
                noAvatars.textContent = "У вас пока нет смайлов для аватара";
                noAvatars.style.color = '#aaa';
                noAvatars.style.padding = '10px';
                avatarOptionsElement.appendChild(noAvatars);
            }
        }

        // Выбор аватара
        function selectAvatar(emoji) {
            gameData.profile.avatar = emoji;
            saveUserData();
            updateUserDisplay();
            renderAvatarOptions();
            showNotification(`Аватар изменен!`);
        }

        // Показать уведомление
        function showNotification(message) {
            notificationElement.textContent = message;
            notificationElement.classList.add('show');
            
            setTimeout(() => {
                notificationElement.classList.remove('show');
            }, 3000);
        }

        // Отрисовка инвентаря
        function renderInventory() {
            inventoryContainer.innerHTML = '';
            
            // Обычные категории
            for (const category in gameData.ownedEmojis) {
                if (category === 'unique' || category === 'custom') continue; // Уникальные и кастомные обрабатываем отдельно
                
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                
                const categoryTitle = document.createElement('h3');
                const ownedCount = gameData.ownedEmojis[category].length;
                const totalCount = emojiDatabase[category].length;
                categoryTitle.innerHTML = `${getCategoryName(category)} <span class="progress">${ownedCount}/${totalCount}</span>`;
                categoryDiv.appendChild(categoryTitle);
                
                const emojiList = document.createElement('div');
                emojiList.className = 'emoji-list';
                
                // Добавляем полученные смайлы
                gameData.ownedEmojis[category].forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.className = 'emoji-item owned';
                    emojiItem.textContent = emoji;
                    emojiList.appendChild(emojiItem);
                });
                
                // Добавляем недоступные смайлы
                emojiDatabase[category].forEach(emoji => {
                    if (!gameData.ownedEmojis[category].includes(emoji)) {
                        const emojiItem = document.createElement('div');
                        emojiItem.className = 'emoji-item missing';
                        emojiItem.textContent = '?';
                        emojiList.appendChild(emojiItem);
                    }
                });
                
                categoryDiv.appendChild(emojiList);
                inventoryContainer.appendChild(categoryDiv);
            }
            
            // Уникальные смайлы
            if (gameData.ownedEmojis.unique.length > 0) {
                const uniqueDiv = document.createElement('div');
                uniqueDiv.className = 'category';
                
                const uniqueTitle = document.createElement('h3');
                uniqueTitle.innerHTML = `💎 Уникальные смайлы <span class="progress">${gameData.ownedEmojis.unique.length}</span>`;
                uniqueDiv.appendChild(uniqueTitle);
                
                const uniqueList = document.createElement('div');
                uniqueList.className = 'emoji-list';
                
                gameData.ownedEmojis.unique.forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    
                    // Проверяем, является ли это анимированным медведем
                    if (emoji === animatedBear) {
                        emojiItem.className = 'animated-bear';
                        emojiItem.innerHTML = `
                            <div class="bear-ear left"></div>
                            <div class="bear-ear right"></div>
                        `;
                    } 
                    // Проверяем, является ли это анимированной тыквой
                    else if (emoji === animatedPumpkin) {
                        emojiItem.className = 'animated-pumpkin';
                        emojiItem.innerHTML = `
                            <div class="pumpkin-stem"></div>
                        `;
                    }
                    else {
                        emojiItem.className = 'emoji-item owned';
                        emojiItem.textContent = emoji;
                    }
                    
                    uniqueList.appendChild(emojiItem);
                });
                
                uniqueDiv.appendChild(uniqueList);
                inventoryContainer.appendChild(uniqueDiv);
            }
            
            // Кастомные смайлы
            if (gameData.ownedEmojis.custom.length > 0) {
                const customDiv = document.createElement('div');
                customDiv.className = 'category';
                
                const customTitle = document.createElement('h3');
                customTitle.innerHTML = `🎨 Кастомные смайлы <span class="progress">${gameData.ownedEmojis.custom.length}</span>`;
                customDiv.appendChild(customTitle);
                
                const customList = document.createElement('div');
                customList.className = 'emoji-list';
                
                gameData.ownedEmojis.custom.forEach(id => {
                    const customData = gameData.customEmojis[id];
                    if (customData) {
                        const emojiItem = document.createElement('div');
                        emojiItem.className = 'custom-emoji';
                        emojiItem.style.width = '60px';
                        emojiItem.style.height = '60px';
                        emojiItem.innerHTML = `
                            <div class="emoji-face">
                                <div class="emoji-eyes">
                                    <div class="eye"></div>
                                    <div class="eye"></div>
                                </div>
                                <div class="emoji-mouth"></div>
                            </div>
                        `;
                        
                        // Применяем настройки кастомного смайла
                        switch(customData.skin) {
                            case 'white':
                                emojiItem.style.background = '#ffdbac';
                                break;
                            case 'black':
                                emojiItem.style.background = '#8d5524';
                                break;
                            case 'rainbow':
                                emojiItem.style.background = 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)';
                                break;
                            case 'shiny':
                                emojiItem.style.background = 'linear-gradient(135deg, #ffcc00, #ff9900, #ffcc00)';
                                break;
                            case 'custom':
                                emojiItem.style.background = customData.customColor;
                                break;
                        }
                        
                        // Применяем настройки глаз
                        const eyes = emojiItem.querySelector('.emoji-eyes');
                        const eyeElements = eyes.querySelectorAll('.eye');
                        
                        switch(customData.eyes) {
                            case 'big':
                                eyeElements.forEach(eye => {
                                    eye.style.width = '16px';
                                    eye.style.height = '16px';
                                });
                                break;
                            case 'small':
                                eyeElements.forEach(eye => {
                                    eye.style.width = '8px';
                                    eye.style.height = '8px';
                                });
                                break;
                            case 'narrow':
                                eyeElements.forEach(eye => {
                                    eye.style.width = '20px';
                                    eye.style.height = '6px';
                                    eye.style.borderRadius = '3px';
                                });
                                break;
                            case 'wide':
                                eyeElements.forEach(eye => {
                                    eye.style.width = '10px';
                                    eye.style.height = '10px';
                                });
                                eyes.style.justifyContent = 'space-between';
                                eyes.style.padding = '0 15px';
                                break;
                            case 'glowing':
                                eyeElements.forEach(eye => {
                                    eye.style.width = '12px';
                                    eye.style.height = '12px';
                                    eye.style.boxShadow = '0 0 10px #ffff00';
                                });
                                break;
                        }

                        // Применяем цвет глаз
                        let eyeColorValue;
                        switch(customData.eyeColor) {
                            case 'black':
                                eyeColorValue = '#000000';
                                break;
                            case 'blue':
                                eyeColorValue = '#0000ff';
                                break;
                            case 'green':
                                eyeColorValue = '#00ff00';
                                break;
                            case 'red':
                                eyeColorValue = '#ff0000';
                                break;
                            case 'custom':
                                eyeColorValue = customData.eyeCustomColor;
                                break;
                            default:
                                eyeColorValue = '#000000';
                        }
                        eyeElements.forEach(eye => {
                            eye.style.background = eyeColorValue;
                        });
                        
                        // Применяем настройки рта
                        const mouth = emojiItem.querySelector('.emoji-mouth');
                        
                        let mouthColorValue;
                        switch(customData.mouthColor) {
                            case 'black':
                                mouthColorValue = '#000000';
                                break;
                            case 'red':
                                mouthColorValue = '#ff0000';
                                break;
                            case 'blue':
                                mouthColorValue = '#0000ff';
                                break;
                            case 'rainbow':
                                mouthColorValue = 'linear-gradient(45deg, #ff0000, #ff9900, #ffff00, #00ff00, #00ffff, #0000ff, #9900ff)';
                                mouth.style.backgroundSize = '200% 200%';
                                mouth.style.animation = 'rainbow-shift 3s infinite linear';
                                break;
                            case 'custom':
                                mouthColorValue = customData.mouthCustomColor;
                                break;
                            default:
                                mouthColorValue = '#000000';
                        }
                        
                        mouth.style.background = mouthColorValue;
                        
                        switch(customData.mouth) {
                            case 'smile':
                                mouth.style.borderRadius = '0 0 15px 15px';
                                mouth.style.width = '30px';
                                mouth.style.height = '15px';
                                break;
                            case 'sad':
                                mouth.style.borderRadius = '15px 15px 0 0';
                                mouth.style.width = '30px';
                                mouth.style.height = '15px';
                                mouth.style.transform = 'translateX(-50%) translateY(5px)';
                                break;
                            case 'none':
                                mouth.style.display = 'none';
                                break;
                            case 'neutral':
                                mouth.style.borderRadius = '0';
                                mouth.style.width = '30px';
                                mouth.style.height = '5px';
                                break;
                        }
                        
                        customList.appendChild(emojiItem);
                    }
                });
                
                customDiv.appendChild(customList);
                inventoryContainer.appendChild(customDiv);
            }
        }

        // Отрисовка таблицы шансов
        function renderRatesTable() {
            ratesTableBody.innerHTML = '';
            
            for (const category in dropRates) {
                const row = document.createElement('tr');
                
                const categoryCell = document.createElement('td');
                categoryCell.textContent = getCategoryName(category);
                row.appendChild(categoryCell);
                
                const rateCell = document.createElement('td');
                rateCell.textContent = `${dropRates[category]}%`;
                row.appendChild(rateCell);
                
                ratesTableBody.appendChild(row);
            }
        }

        // Получение названия категории
        function getCategoryName(category) {
            const names = {
                faces: "😀 Смайлы лица",
                nature: "🌿 Смайлы природа",
                food: "🍏 Смайлы еда",
                games: "🏀 Смайлы игры",
                travel: "🚗 Смайлы туризм и машины",
                tech: "💻 Смайлы техника",
                symbols: "❤️ Смайлы знаки",
                unique: "💎 Уникальные смайлы",
                disappear: "💥 Исчезают все смайлы"
            };
            
            return names[category] || category;
        }

        // Запуск игры
        initGame();

        // Добавляем обработку ошибок для аудио
        window.addEventListener('DOMContentLoaded', function() {
            const backgroundMusic = document.getElementById('background-music');
            const bossMusic = document.getElementById('boss-music');
            
            if (backgroundMusic) {
                backgroundMusic.addEventListener('error', function() {
                    console.warn('Фоновая музыка не найдена, игра продолжится без звука');
                });
            }
            
            if (bossMusic) {
                bossMusic.addEventListener('error', function() {
                    console.warn('Музыка босса не найдена');
                });
            }
        });
    </script>
</body>
</html>
